(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))n(r);new MutationObserver(r=>{for(const s of r)if(s.type==="childList")for(const i of s.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&n(i)}).observe(document,{childList:!0,subtree:!0});function o(r){const s={};return r.integrity&&(s.integrity=r.integrity),r.referrerPolicy&&(s.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?s.credentials="include":r.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function n(r){if(r.ep)return;r.ep=!0;const s=o(r);fetch(r.href,s)}})();(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))o(n);new MutationObserver(n=>{for(const r of n)if(r.type==="childList")for(const s of r.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&o(s)}).observe(document,{childList:!0,subtree:!0});function t(n){const r={};return n.integrity&&(r.integrity=n.integrity),n.referrerPolicy&&(r.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?r.credentials="include":n.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function o(n){if(n.ep)return;n.ep=!0;const r=t(n);fetch(n.href,r)}})();function M(){return fetch("views/homeView.html").then(e=>e.text()).then(e=>{document.getElementById("app").innerHTML=e})}const be=Object.freeze(Object.defineProperty({__proto__:null,renderHome:M},Symbol.toStringTag,{value:"Module"})),Y="http://localhost:5001",xe=["/api/forgot-password/request","/api/forgot-password/verify","/api/forgot-password/reset"];async function y(e,t={}){const o=Y,n=sessionStorage.getItem("token"),r={"Content-Type":"application/json",...xe.includes(e)?{}:n?{Authorization:`Bearer ${n}`}:{},...t.headers||{}},s=`${o}${e}`;try{console.log(`API Call: ${t.method||"GET"} ${s}`);const i=await fetch(s,{...t,headers:r});if(!i.ok){let l="";try{l=await i.text()}catch(c){l=`Failed to read error response: ${c.message}`}throw console.error(`API Call failed for ${e}: HTTP ${i.status} - ${l}`),new Error(`HTTP ${i.status} - ${l}`)}const a=i.headers.get("content-type");if(a&&a.includes("application/json"))return await i.json();{const l=await i.text();return console.warn(`Non-JSON response for ${e}:`,l),l}}catch(i){throw console.error("API Call failed for",e,":",i),i}}async function A(e,t={}){const o=sessionStorage.getItem("token");if(!o)throw new Error("No authentication token found. Please log in.");const n={...t.headers||{},Authorization:`Bearer ${o}`};return y(e,{...t,headers:n})}function I(){fetch("views/loginView.html").then(e=>e.text()).then(e=>{document.getElementById("app").innerHTML=e,Ee()}).catch(e=>{console.error("Error loading login view:",e),document.getElementById("app").innerHTML="<p>Error loading login page</p>"})}function Ee(){const e=document.getElementById("loginButton"),t=document.getElementById("errorMessage");if(!e||!t){console.error("Login elements not found");return}function o(i){t.textContent=i,t.style.display="block"}function n(){t.textContent="",t.style.display="none"}e.addEventListener("click",async i=>{var a,l;i.preventDefault(),n();const c=(a=document.getElementById("loginEmail"))==null?void 0:a.value.trim(),d=(l=document.getElementById("loginPassword"))==null?void 0:l.value.trim();if(!c||!d){o("Please fill in all fields.");return}try{e.disabled=!0,e.textContent="Logging in...";const u=await y("/api/auth/login",{method:"POST",body:JSON.stringify({email:c,password:d})});u.token&&u.user&&(window.login&&window.login(u.user,u.token),await ke(),await window.updateNavbar(),window.loadView("dashboard")),n()}catch(u){console.error("Login error:",u),o(u.message)}finally{e.disabled=!1,e.textContent="Log In"}});const r=document.getElementById("signupLink");r&&r.addEventListener("click",i=>{i.preventDefault(),window.loadView&&window.loadView("signup")});const s=document.getElementById("forgotPasswordLink");s&&s.addEventListener("click",i=>{i.preventDefault(),window.loadView&&window.loadView("forgetpassword")})}async function ke(){const e=sessionStorage.getItem("token");if(!e){console.warn("No token found, skipping profile fetch");return}try{const t=await y("/api/auth/profile",{method:"GET",headers:{Authorization:`Bearer ${e}`}});if(t.user){const o=t.user;sessionStorage.setItem("user",JSON.stringify(o)),z(o)}}catch(t){console.error("Error fetching user profile:",t);const o=JSON.parse(sessionStorage.getItem("user")||"{}");o&&z(o)}}function Ie(e,t){var o;const n="https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_960_720.png";try{if(!(t!=null&&t.img)){e.src=n;return}if(typeof t.img=="string"){if(t.img.startsWith("http")||t.img.startsWith("data:image/")){e.src=t.img;return}if(t.img.startsWith("\\x"))try{const r=((o=t.img.substring(2).match(/.{2}/g))==null?void 0:o.map(s=>String.fromCharCode(parseInt(s,16))).join(""))||"";if(r.startsWith("http")){e.src=r;return}}catch(r){console.error("Error decoding hex string:",r)}}if(t.img&&typeof t.img=="object"&&t.img.data){const r=Le(t.img.data);if(r){e.src=r;return}}e.src=n,e.onerror=()=>{console.warn("Failed to load profile image, using default"),e.src=n,e.onerror=null}}catch(r){console.error("Error displaying profile image:",r),e.src=n}}function Le(e){try{if(!e)return null;let t="",o;if(e instanceof ArrayBuffer)o=new Uint8Array(e);else if(e instanceof Uint8Array)o=e;else if(Array.isArray(e))o=new Uint8Array(e);else return console.warn("Unknown binary data format:",typeof e),null;const n=8192;for(let r=0;r<o.length;r+=n){const s=o.subarray(r,Math.min(r+n,o.length));t+=String.fromCharCode.apply(null,s)}return"data:image/jpeg;base64,"+btoa(t)}catch(t){return console.error("Error converting binary to base64:",t),null}}function z(e){if(!e){console.warn("No user data provided to updateNavbarUI");return}const t=document.getElementById("profile-image"),o=document.getElementById("dropdown-username"),n=document.getElementById("dropdown-email");t&&Ie(t,e),o&&(o.textContent=e.name||"User"),n&&(n.textContent=e.email||"")}function Be(){fetch("views/signupView.html").then(e=>e.text()).then(e=>{document.getElementById("app").innerHTML=e,Ce()}).catch(e=>{console.error("Error loading signup view:",e),document.getElementById("app").innerHTML="<p>Error loading signup page</p>"})}function Ce(){const e=document.getElementById("signupButton"),t=document.getElementById("errorMessage");if(!e||!t){console.error("Signup elements not found");return}function o(s){t.textContent=s,t.style.display="block"}function n(){t.textContent="",t.style.display="none"}e.addEventListener("click",async s=>{var i,a,l,c,d;s.preventDefault(),n();const u=(i=document.getElementById("signupName"))==null?void 0:i.value.trim(),g=(a=document.getElementById("signupEmail"))==null?void 0:a.value.trim(),f=(l=document.getElementById("signupPassword"))==null?void 0:l.value.trim(),v=(c=document.getElementById("signupConfirmPassword"))==null?void 0:c.value.trim(),k=(d=document.getElementById("termsCheckbox"))==null?void 0:d.checked;if(!u||!g||!f||!v){o("Please fill in all fields.");return}if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(g)){o("Please enter a valid email address.");return}if(f!==v){o("Passwords do not match.");return}if(!k){o("You must agree to the Terms & Privacy Policy.");return}try{e.disabled=!0,e.textContent="Creating Account...";const b=await y("/api/auth/register",{method:"POST",body:JSON.stringify({name:u,email:g,password:f})});n(),window.loadView&&window.loadView("login")}catch(b){console.error("Registration error:",b),o(b.message)}finally{e.disabled=!1,e.textContent="Sign Up"}});const r=document.getElementById("loginLink");r&&r.addEventListener("click",s=>{s.preventDefault(),window.loadView&&window.loadView("login")})}function R(){fetch("views/curhat.html").then(e=>{if(!e.ok)throw new Error("Failed to load curhat.html");return e.text()}).then(e=>{document.getElementById("app").innerHTML=e;const t=document.getElementById("username"),o=JSON.parse(sessionStorage.getItem("user")||"{}").name||"User";t&&(t.textContent=o);const n=document.querySelector(".nav-links a[href='#']");n&&n.addEventListener("click",i=>{i.preventDefault(),window.logout&&window.logout()});const r=document.getElementById("submitCurhat"),s=document.getElementById("curhatInput");if(document.getElementById("result"),!r||!s){console.warn("Required form elements not found in curhat.html.");return}r.addEventListener("click",async()=>{const i=s.value.trim(),a=JSON.parse(sessionStorage.getItem("user")||"{}").user_id||null;if(!i){alert("Please enter your text.");return}if(i.length<50){alert("Please enter at least 50 characters.");return}console.log("Submitting text:",i.substring(0,50)+"..."),console.log("User ID:",a),Se();try{const l=await y("/api/curhat",{method:"POST",headers:{"Content-Type":"application/json",...sessionStorage.getItem("token")&&{Authorization:`Bearer ${sessionStorage.getItem("token")}`}},body:JSON.stringify({text:i,user_id:a})});if(console.log("Backend Response received:",l),!l||typeof l!="object")throw new Error("Invalid response format from server");const c={user_input:i,predicted_emotion:l.predicted_emotion||{label:"neutral"},predicted_stress:l.predicted_stress||{label:"medium"},stress_level:l.stress_level||{stress_level:50},analysis:l.analysis||"Analysis completed successfully.",keywords:l.keywords||[],recommended_videos:l.recommended_videos||{recommendations:[]},timestamp:new Date().toISOString(),saved_to_history:l.saved_to_history||!1};console.log("Enhanced result object:",c),sessionStorage.setItem("curhatResult",JSON.stringify(c)),s.value="",window.loadView?(console.log("Navigating to feedback view"),window.loadView("feedback")):console.error("window.loadView function not found")}catch(l){console.error("Error occurred:",l);let c="Failed to process your submission. ";l.message.includes("Failed to fetch")||l.message.includes("NetworkError")?c+="Please check if your backend server is running on localhost:5001.":l.message.includes("timeout")?c+="The request timed out. The ML API might be slow to respond. Please try again.":l.message.includes("ML API")?c+="There was an issue with the ML analysis service. Please try again later.":c+=`Details: ${l.message}`,alert(c)}finally{Me()}})}).catch(e=>{console.error("Error loading curhat view:",e)})}function Se(){const e=document.getElementById("spinner");e&&e.classList.remove("hidden");const t=document.getElementById("submitCurhat");t&&(t.disabled=!0,t.textContent="Processing...")}function Me(){const e=document.getElementById("spinner");e&&e.classList.add("hidden");const t=document.getElementById("submitCurhat");t&&(t.disabled=!1,t.textContent="Submit")}const Pe=Object.freeze(Object.defineProperty({__proto__:null,renderCurhat:R},Symbol.toStringTag,{value:"Module"})),x=function(e,t,o){let n=Promise.resolve();function r(s){const i=new Event("vite:preloadError",{cancelable:!0});if(i.payload=s,window.dispatchEvent(i),!i.defaultPrevented)throw s}return n.then(s=>{for(const i of s||[])i.status==="rejected"&&r(i.reason);return e().catch(r)})};function Z(){fetch("views/feedbackView.html").then(e=>{if(!e.ok)throw new Error("Failed to load feedbackView.html");return e.text()}).then(e=>{document.getElementById("app").innerHTML=e;const t=localStorage.getItem("username")||"User",o=document.getElementById("username");o&&(o.textContent=t),$e(),He()}).catch(e=>{console.error("Error loading feedback view:",e)})}function $e(){[{selector:'a[href="#dashboard"]',view:"dashboard"},{selector:'a[href="#history"]',view:"history"},{selector:'a[href="#logout"]',view:"logout"}].forEach(({selector:e,view:t})=>{const o=document.querySelector(e);o&&o.addEventListener("click",n=>{n.preventDefault(),t==="logout"?G():Te(t)})})}function G(){localStorage.clear(),location.reload()}function Te(e){switch(e){case"dashboard":x(()=>Promise.resolve().then(()=>ce)).then(t=>t.renderDashboard());break;case"history":x(()=>Promise.resolve().then(()=>pe)).then(t=>t.renderHistory());break;case"logout":G();break;default:console.warn(`View '${e}' tidak dikenali`)}}function He(){const e=JSON.parse(sessionStorage.getItem("curhatResult"));if(!e){console.warn("No feedback result found in sessionStorage.");return}Ae(e),Ne(e),_e(e)}function Ae(e){var t,o,n,r;const s=document.getElementById("percentage"),i=document.querySelector(".result-card .flex > :first-child");if(s&&i){const d=((t=e.stress_level)==null?void 0:t.stress_level)||0;s.textContent=`${d}%`;const u=50,g=2*Math.PI*u,f=g-d/100*g;i.innerHTML=`
      <svg width="120" height="120" viewBox="0 0 120 120" class="transform -rotate-90">
        <circle cx="60" cy="60" r="${u}" fill="none" stroke="#e5e7eb" stroke-width="20" />
        <circle cx="60" cy="60" r="${u}" fill="none" stroke="url(#gradient)" stroke-width="20" stroke-dasharray="${g}" stroke-dashoffset="${f}" />
        <defs>
          <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" style="stop-color:#6b21a8;" />
            <stop offset="100%" style="stop-color:#a78bfa;" />
          </linearGradient>
        </defs>
      </svg>
      <div class="absolute inset-0 flex items-center justify-center text-violet-800 font-bold text-xl">
        <span id="percentage">${d}%</span>
      </div>
    `,i.classList.add("relative"),i.style.width="120px",i.style.height="120px"}const a=document.getElementById("stress-title");a&&(a.textContent=((o=e.predicted_stress)==null?void 0:o.label)||"Unknown");const l=document.getElementById("emotion-badge");l&&(l.textContent=`Emotion: ${((n=e.predicted_emotion)==null?void 0:n.label)||"Unknown"}`);const c=document.querySelectorAll(".video-box .video-embed");(r=e.recommended_videos)!=null&&r.recommendations&&c.forEach((d,u)=>{const g=e.recommended_videos.recommendations[u];if(!g){d.innerHTML='<p class="text-gray-500 italic">Video unavailable.</p>';return}const f=g.split("/embed/")[1];if(!f){d.innerHTML='<p class="text-gray-500 italic">Video unavailable.</p>';return}d.innerHTML=`
        <iframe 
          src="https://www.youtube.com/embed/${f}" 
          frameborder="0" 
          allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" 
          allowfullscreen 
          class="w-full h-full rounded-lg">
        </iframe>`})}function Ne(e){const t=document.getElementById("user-input");t&&(t.textContent=e.user_input||"No input provided.")}function _e(e){const t=document.querySelector(".reason-box");if(t&&e.analysis){const o=t.querySelector("p");if(o){const r=e.analysis.split("Suggestions:");let s=r[0].replace(/^-\s*|\s*-$/g,"").trim();const i=r[1]?r[1].trim():"",a="Why you're getting this result:";s.startsWith(a)&&(s=s.slice(a.length).trim()),o.innerHTML=`
        <strong>Why you're getting this result:</strong> ${s}
        ${i?`<br><br><strong>Suggestions:</strong> ${i}`:""}
      `}const n=document.getElementById("keyword-list");n&&n.remove()}}class De{async getFeedbackHistory(){try{const t=await fetch("http://localhost:5001/api/submissions");if(!t.ok)throw new Error("Failed to fetch feedback history");return await t.json()}catch(t){return console.error(t),[]}}}const je=Object.freeze(Object.defineProperty({__proto__:null,FeedbackPresenter:De,renderFeedback:Z},Symbol.toStringTag,{value:"Module"}));function O(){fetch("views/dashboardView.html").then(e=>{if(!e.ok)throw new Error("Failed to load dashboardView.html");return e.text()}).then(e=>{document.getElementById("app").innerHTML=e,Oe().then(()=>{ze(),K()})}).catch(e=>{console.error("Error loading dashboard:",e),U("Failed to load dashboard. Please try again.")})}function Oe(){return new Promise((e,t)=>{if(window.Chart){e();return}const o=document.createElement("script");o.src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js",o.onload=e,o.onerror=t,document.head.appendChild(o)})}const F={anxious:"üò∞",depressed:"üòî",overwhelmed:"üò©",panicked:"üò®",lonely:"üòê"};let m={averageStress:0,stressHistory:[],emotionCounts:{},latestEmotion:"neutral",recentPredictions:[],tips:[],totalSessions:0,weeklyStressLevel:"",avgMood:"",recentActivity:[]},w={};async function K(){try{ae(),await Promise.all([Q(),X()]),await ee(),te(),Fe(),oe(),ne(),re(),se(),ie(),Ue(),Ve(),$()}catch(e){console.error("Error initializing dashboard:",e),$(),U("Failed to load dashboard data. Please refresh the page.")}}async function Q(){try{const e=qe(),t=await A(`/api/dashboard/summary?days=${e}`,"GET");m.averageStress=t.averageStress||0,m.emotionCounts=t.emotionCounts||{},m.stressHistory=t.stressHistory||[],m.latestEmotion=t.latestEmotion||"neutral",m.totalSessions=t.totalCount||0,m.weeklyStressLevel=t.mostCommonStressLevel||"Low",m.avgMood=t.mostCommonEmotion||"neutral"}catch(e){throw console.error("Error loading dashboard summary:",e),e}}async function X(e=10){try{const t=await A(`/api/dashboard/recent?limit=${e}`,"GET");m.recentPredictions=t.map(o=>({date:o.created_at,emotion:o.emotion,stress_level:o.stress_level,stress_percent:o.stress_percent,text:o.text,feedback:o.feedback,history_id:o.history_id})),m.recentActivity=t.slice(0,5).map(o=>({date:o.created_at,text:o.text,emotion:o.emotion}))}catch(t){throw console.error("Error loading recent history:",t),t}}async function ee(){try{const e=[];if(m.recentPredictions.length>0&&m.recentPredictions[0].feedback){const t=m.recentPredictions[0].feedback,o=t.indexOf("Why you're getting this result:"),n=t.indexOf("Suggestions:");let r="",s="";o!==-1&&n!==-1&&(r=t.substring(o+31,n).trim(),s=t.substring(n+12).trim(),r&&e.push(`${r}`),s&&e.push(`${s}`))}m.tips=e,m.tips.length===0&&(m.tips=["‚Ä¢ Take regular breaks throughout the day","‚Ä¢ Practice deep breathing exercises","‚Ä¢ Maintain a consistent sleep schedule","‚Ä¢ Engage in physical activities","‚Ä¢ Try meditation or mindfulness exercises"])}catch(e){console.error("Error loading stress tips:",e),m.tips=["‚Ä¢ Take regular breaks throughout the day","‚Ä¢ Practice deep breathing exercises","‚Ä¢ Maintain a consistent sleep schedule","‚Ä¢ Engage in physical activities"]}}function te(){const e=document.getElementById("stress-percentage");e&&(e.textContent=`${m.averageStress}%`,m.averageStress>=70?e.className="text-4xl sm:text-6xl font-bold text-red-600 mb-3 sm:mb-4":m.averageStress>=40?e.className="text-4xl sm:text-6xl font-bold text-yellow-600 mb-3 sm:mb-4":e.className="text-4xl sm:text-6xl font-bold text-green-600 mb-3 sm:mb-4")}function Fe(){const e=document.getElementById("latest-emotion-emoji"),t=document.getElementById("latest-emotion-text");if(!e||!t)return;const o=m.latestEmotion.toLowerCase();e.textContent=F[o]||"üòê",t.textContent=o.charAt(0).toUpperCase()+o.slice(1)}function oe(){const e=document.getElementById("total-predictions");e&&(e.textContent=m.totalSessions);const t=document.getElementById("week-predictions");t&&(t.textContent=m.weeklyStressLevel);const o=document.getElementById("avg-mood");if(o){const n=m.avgMood.charAt(0).toUpperCase()+m.avgMood.slice(1);o.textContent=n}}function ne(){const e=document.getElementById("emotion-chart");if(!e||!window.Chart)return;w.emotionChart&&w.emotionChart.destroy();const t=e.getContext("2d"),o=["depressed","panicked","anxious","overwhelmed","lonely"],n=o.map(c=>m.emotionCounts[c.charAt(0).toUpperCase()+c.slice(1)]||0),r=n.reduce((c,d)=>c+d,0),s=document.getElementById("emotion-chart-total");s&&(s.textContent=r),o.forEach(c=>{const d=document.getElementById(`${c}-count`);d&&(d.textContent=m.emotionCounts[c.charAt(0).toUpperCase()+c.slice(1)]||0)});const i=["#5e4fa2","#9e7bb5","#d4a5e3","#e0b0e4","#f1d4e0"],a=o.map((c,d)=>({name:c,count:n[d]}));a.sort((c,d)=>d.count-c.count);const l=a.map((c,d)=>i[d]);r>0?w.emotionChart=new Chart(t,{type:"doughnut",data:{labels:o.map(c=>c.charAt(0).toUpperCase()+c.slice(1)),datasets:[{data:n,backgroundColor:l,borderWidth:0}]},options:{responsive:!0,maintainAspectRatio:!1,cutout:"70%",plugins:{legend:{display:!1}}}}):(t.clearRect(0,0,e.width,e.height),t.fillStyle="#6b7280",t.font="14px sans-serif",t.textAlign="center",t.fillText("No data available",e.width/2,e.height/2))}function re(){const e=document.getElementById("stress-chart");if(!e||!window.Chart)return;w.stressChart&&w.stressChart.destroy();const t=e.getContext("2d");if(m.stressHistory.length===0){t.clearRect(0,0,e.width,e.height),t.fillStyle="#6b7280",t.font="14px sans-serif",t.textAlign="center",t.fillText("No stress data available",e.width/2,e.height/2);return}const o=m.stressHistory.map(r=>{let s;return typeof r.date=="string"?s=new Date(r.date):typeof r.date=="number"?s=new Date(r.date*1e3):s=r.date,s.toLocaleDateString("en-US",{month:"short",day:"numeric"})}),n=m.stressHistory.map(r=>r.value||r.stress_percent||0);w.stressChart=new Chart(t,{type:"line",data:{labels:o,datasets:[{label:"Stress Level (%)",data:n,borderColor:"#ef4444",backgroundColor:"rgba(239, 68, 68, 0.1)",tension:.4,fill:!0,pointBackgroundColor:n.map(r=>r>=70?"#dc2626":r>=40?"#f59e0b":"#10b981"),pointBorderColor:"#ffffff",pointBorderWidth:2,pointRadius:4}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1}},scales:{y:{beginAtZero:!0,max:100,ticks:{callback:function(r){return r+"%"}}},x:{grid:{display:!1}}}}})}function se(){const e=document.getElementById("predictions-table");if(!e)return;e.innerHTML="";const t=m.recentPredictions.slice(0,5);if(t.length===0){e.innerHTML=`
      <tr>
        <td colspan="5" class="px-6 py-8 text-center text-gray-500">
          No predictions found
        </td>
      </tr>
    `;return}t.forEach(o=>{var n;const r=document.createElement("tr");r.className="border-b hover:bg-gray-50";const s=o.stress_percent>=70?"text-red-600":o.stress_percent>=40?"text-yellow-600":"text-green-600";let i="No suggestion available";if(o.feedback){const c=o.feedback.toLowerCase().indexOf("suggestion");c!==-1&&(i=o.feedback.substring(c).split(`
`)[0].replace(/suggestion[s]?[:\-]\s*/i,"").trim(),i.length>50&&(i=i.substring(0,50)+"..."))}let a=o.text||"No text available";a.length>60&&(a=a.substring(0,60)+"...");let l;try{l=new Date(o.date).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"})}catch{l="Invalid date"}r.innerHTML=`
      <td class="px-6 py-4 text-sm text-gray-900">
        ${l}
      </td>
      <td class="px-6 py-4 text-sm">
        <span class="inline-flex items-center">
          <span class="mr-2">${F[(n=o.emotion)==null?void 0:n.toLowerCase()]||"üòê"}</span>
          ${o.emotion?o.emotion.charAt(0).toUpperCase()+o.emotion.slice(1):"Unknown"}
        </span>
      </td>
      <td class="px-6 py-4 text-sm text-gray-500" title="${o.text}">
        ${a}
      </td>
      <td class="px-6 py-4 text-sm font-medium ${s}">
        ${o.stress_level||"N/A"} (${o.stress_percent||0}%)
      </td>
      <td class="px-6 py-4 text-sm text-gray-500" title="${i}">
        ${i.length>40?i.substring(0,40)+"...":i}
      </td>
    `,e.appendChild(r)})}function ie(){const e=document.getElementById("stress-tips");e&&(e.innerHTML="",m.tips.forEach(t=>{const o=document.createElement("li");o.className="flex items-start",o.innerHTML=`
      <span class="flex-shrink-0 w-2 h-2 bg-purple-500 rounded-full mt-2 mr-3"></span>
      <span class="text-sm text-gray-700">${t}</span>
    `,e.appendChild(o)}))}function Ue(){const e=document.getElementById("recent-activity");if(e){if(e.innerHTML="",m.recentActivity.length===0){e.innerHTML='<div class="text-sm text-gray-500 text-center py-4">No recent activity</div>';return}m.recentActivity.forEach(t=>{var o;const n=document.createElement("div");n.className="flex items-start space-x-3 p-3 bg-gray-50 rounded-lg mb-2";let r=t.text||"No text available";r.length>80&&(r=r.substring(0,80)+"...");let s;try{s=new Date(t.date).toLocaleDateString("en-US",{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}catch{s="Invalid date"}n.innerHTML=`
      <span class="text-lg">${F[(o=t.emotion)==null?void 0:o.toLowerCase()]||"üòê"}</span>
      <div class="flex-1 min-w-0">
        <p class="text-sm text-gray-900">${r}</p>
        <p class="text-xs text-gray-500">${s}</p>
      </div>
    `,e.appendChild(n)})}}function Ve(){const e=document.getElementById("time-filter");e&&e.addEventListener("change",async function(n){await J()});const t=document.getElementById("chart-filter");t&&t.addEventListener("change",async function(n){await J()});const o=document.getElementById("refresh-dashboard");o&&o.addEventListener("click",async()=>{await K()})}function qe(){const e=document.getElementById("time-filter");return e?parseInt(e.value):30}async function J(){try{ae(),await Promise.all([Q(),X()]),await ee(),te(),oe(),re(),ne(),se(),ie(),$()}catch(e){console.error("Error refreshing dashboard:",e),$(),U("Failed to refresh dashboard data")}}function ae(){document.querySelectorAll(".loading-placeholder").forEach(e=>e.classList.remove("hidden"))}function $(){document.querySelectorAll(".loading-placeholder").forEach(e=>e.classList.add("hidden"))}function U(e){const t=document.createElement("div");t.className="fixed top-4 right-4 bg-red-500 text-white px-4 py-2 rounded shadow-lg z-50",t.textContent=e,document.body.appendChild(t),setTimeout(()=>{document.body.contains(t)&&document.body.removeChild(t)},5e3)}function ze(){[{selector:'a[href="#home"]',view:"home"},{selector:'a[href="#curhat"]',view:"curhat"},{selector:'a[href="#feedback"]',view:"feedback"},{selector:'a[href="#dashboard"]',view:"dashboard"},{selector:'a[href="#logout"]',view:"logout"}].forEach(({selector:e,view:t})=>{const o=document.querySelector(e);o&&o.addEventListener("click",n=>{n.preventDefault(),t==="logout"?Je():le(t)})})}function Je(){Object.values(w).forEach(e=>{e&&typeof e.destroy=="function"&&e.destroy()}),w={},localStorage.clear(),sessionStorage.removeItem("isLoggedIn"),console.log("User logged out, session cleared"),le("home")}function le(e){switch(e!=="dashboard"&&(Object.values(w).forEach(t=>{t&&typeof t.destroy=="function"&&t.destroy()}),w={}),e){case"home":x(()=>Promise.resolve().then(()=>be)).then(t=>t.renderHome());break;case"curhat":x(()=>Promise.resolve().then(()=>Pe)).then(t=>t.renderCurhat());break;case"feedback":x(()=>Promise.resolve().then(()=>je)).then(t=>t.renderFeedback());break;case"dashboard":O();break;default:console.warn("Unknown view:",e);break}}const ce=Object.freeze(Object.defineProperty({__proto__:null,renderDashboard:O},Symbol.toStringTag,{value:"Module"}));function We(){return fetch("views/forgetPasswordView.html").then(e=>{if(!e.ok)throw new Error("Failed to load forget password view");return e.text()}).then(e=>{document.getElementById("app").innerHTML=e,Ye()}).catch(e=>{console.error("Error loading forget password view:",e),p("Failed to load page")})}function Ye(){const e=document.getElementById("send-code-btn"),t=document.getElementById("verify-code-btn"),o=document.getElementById("reset-password-btn"),n=document.getElementById("back-to-login");e?e.addEventListener("click",r=>Re(r,e)):console.error("sendCodeBtn not found in DOM"),t?t.addEventListener("click",r=>Ze(r,t)):console.error("verifyCodeBtn not found in DOM"),o?o.addEventListener("click",r=>Ge(r,o)):console.error("resetPasswordBtn not found in DOM"),n?n.addEventListener("click",r=>{r.preventDefault(),window.loadView("login")}):console.error("backToLoginLink not found in DOM")}async function Re(e,t){e.preventDefault();const o=document.getElementById("loginEmail"),n=o==null?void 0:o.value.trim();if(N(),console.log("handleSendCode started with email:",n),!n){p("email-error","Email is required"),alert("Error: Email is required");return}if(!/\S+@\S+\.\S+/.test(n)){p("email-error","Invalid email format"),alert("Error: Invalid email format");return}if(!t){console.error("Button reference is undefined in handleSendCode"),p("email-error","Internal error: Button not found"),alert("Error: Internal error - Button not found");return}L(!0,t),console.log("Sending request to /api/forgot-password/request with email:",n);try{const r=await y("/api/forgot-password/request",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:n})});if(console.log("API response received:",r),!r.message)throw new Error("Invalid response from server");de("code-stage"),V("Verification code sent to your email"),alert("Success: Verification code sent to your email!")}catch(r){console.error("API call failed:",r),p("email-error",r.message||"Failed to send code"),alert(`Error: Failed to send code - ${r.message||"Unknown error"}`)}finally{L(!1,t),console.log("handleSendCode completed")}}async function Ze(e,t){var o;e.preventDefault();const n=(o=document.getElementById("loginEmail"))==null?void 0:o.value.trim(),r=document.getElementById("verificationCode"),s=r==null?void 0:r.value.trim();if(N(),!s){p("code-error","Code is required");return}if(!/^\d{6}$/.test(s)){p("code-error","Code must be a 6-digit number");return}if(!t){console.error("Button reference is undefined in handleVerifyCode"),p("code-error","Internal error: Button not found");return}L(!0,t);try{if(!(await y("/api/forgot-password/verify",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:n,code:s})})).message)throw new Error("Invalid response from server");de("password-stage"),V("Code verified successfully")}catch(i){p("code-error",i.message||"Invalid or expired code")}finally{L(!1,t)}}async function Ge(e,t){var o;e.preventDefault();const n=(o=document.getElementById("loginEmail"))==null?void 0:o.value.trim(),r=document.getElementById("newPassword"),s=document.getElementById("confirmPassword"),i=r==null?void 0:r.value,a=s==null?void 0:s.value;if(N(),!i||!a){i||p("new-password-error","New password is required"),a||p("confirm-password-error","Confirm password is required");return}const l=Ke(i);if(!l.isValid){p("new-password-error",l.message);return}if(i!==a){p("confirm-password-error","Passwords do not match");return}if(!t){console.error("Button reference is undefined in handleResetPassword"),p("new-password-error","Internal error: Button not found");return}L(!0,t);try{if(!(await y("/api/forgot-password/reset",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:n,newPassword:i})})).message)throw new Error("Invalid response from server");V("Password reset successfully! Redirecting to login..."),setTimeout(()=>window.loadView("login"),2e3)}catch(c){p("new-password-error",c.message||"Failed to reset password")}finally{L(!1,t)}}function Ke(e){const t=/[a-zA-Z]/.test(e),o=/\d/.test(e),n=/[!@#$%^&*(),.?":{}|<>]/.test(e);return e.length<8||!(t&&o&&n)?{isValid:!1,message:"Password must be at least 8 characters long and include a mix of letters, numbers, and symbols."}:{isValid:!0,message:""}}function de(e){["email-stage","code-stage","password-stage"].forEach(o=>{const n=document.getElementById(o);n&&n.classList.add("hidden")});const t=document.getElementById(e);t&&t.classList.remove("hidden")}function p(e,t){const o=document.getElementById(e);o&&(o.textContent=t,o.classList.remove("hidden"))}function N(){document.querySelectorAll("[id$='-error']").forEach(e=>{e.textContent="",e.classList.add("hidden")})}function V(e){N();const t=document.getElementById("email-error");t&&(t.textContent=e,t.classList.remove("hidden","text-red-600"),t.classList.add("text-green-600"))}function L(e,t){e?(t.disabled=!0,t.textContent="Processing..."):(t.disabled=!1,t.textContent=t.id==="send-code-btn"?"Send Code":t.id==="verify-code-btn"?"Verify Code":"Reset Password")}function Qe(){fetch("views/articlesView.html").then(e=>{if(!e.ok)throw new Error("Failed to load articlesView.html");return e.text()}).then(e=>{document.getElementById("app").innerHTML=e,console.log("Articles view loaded, initializing..."),ot(),Xe()}).catch(e=>{console.error("Error loading articles view:",e),document.getElementById("app").innerHTML=`
        <div class="p-4 text-center">
          <h2 class="text-xl font-bold text-red-600">Error Loading Articles</h2>
          <p class="text-gray-600">Failed to load the articles view: ${e.message}</p>
        </div>
      `})}window.allArticles=[];window.filteredArticles=[];window.currentPage=1;window.articlesPerPage=12;function Xe(){const e=document.querySelector(".articles-section");if(e&&!document.getElementById("search-input")){const n=`
      <div class="mb-6 max-w-md">
        <div class="relative">
          <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
            <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
            </svg>
          </div>
          <input type="text" id="search-input" placeholder="Search articles..." 
                 class="block w-full pl-10 pr-10 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-violet-500 focus:border-violet-500 outline-none transition-all duration-200">
          <button id="clear-search" class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600 hidden">
            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
        <div id="search-info" class="mt-2 text-sm text-gray-600 hidden">
          <span id="results-count"></span> articles found
        </div>
      </div>
    `,r=e.querySelector("h2");r&&r.insertAdjacentHTML("afterend",n)}const t=document.getElementById("search-input"),o=document.getElementById("clear-search");t&&t.addEventListener("input",et),o&&o.addEventListener("click",tt)}function et(e){const t=e.target.value.toLowerCase().trim(),o=document.getElementById("clear-search"),n=document.getElementById("search-info"),r=document.getElementById("results-count");t&&o?o.classList.remove("hidden"):o&&o.classList.add("hidden"),t&&n?n.classList.remove("hidden"):n&&n.classList.add("hidden"),t===""?window.filteredArticles=window.allArticles:window.filteredArticles=window.allArticles.filter(s=>s.title&&s.title.toLowerCase().includes(t)||s.article_intro&&s.article_intro.toLowerCase().includes(t)),r&&(r.textContent=window.filteredArticles.length),window.currentPage=1,B(window.filteredArticles)}function tt(){const e=document.getElementById("search-input"),t=document.getElementById("clear-search"),o=document.getElementById("search-info");e&&(e.value=""),t&&t.classList.add("hidden"),o&&o.classList.add("hidden"),window.filteredArticles=window.allArticles,window.currentPage=1,B(window.filteredArticles)}async function ot(){const e=document.getElementById("articles-container");try{e&&(e.innerHTML=`
        <div class="flex justify-center items-center py-8">
          <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-violet-700"></div>
          <span class="ml-2 text-gray-600">Loading articles...</span>
        </div>
      `),console.log("Fetching articles...");const t=await nt();if(console.log("Received articles:",{count:t.length,sample:t.slice(0,2)}),!t||t.length===0){console.log("No articles received"),e&&(e.innerHTML=`
          <div class="text-center py-8">
            <svg class="mx-auto h-12 w-12 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6-4h6"></path>
            </svg>
            <h3 class="text-lg font-semibold text-gray-700">No Articles Available</h3>
            <p class="text-gray-500">Check back later for new content!</p>
          </div>
        `);return}window.allArticles=t,window.filteredArticles=t,window.currentPage=1,console.log("Rendering article cards..."),B(t)}catch(t){console.error("Error initializing articles:",t),e&&(e.innerHTML=`
        <div class="text-center py-8">
          <div class="bg-red-50 border border-red-200 rounded-lg p-6 max-w-md mx-auto">
            <svg class="mx-auto h-12 w-12 text-red-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <h3 class="text-lg font-semibold text-red-600 mb-2">Failed to Load Articles</h3>
            <p class="text-gray-600 mb-4">${t.message}</p>
            <button onclick="location.reload()" class="px-4 py-2 bg-violet-700 text-white rounded-lg hover:bg-violet-800 transition-colors duration-200">
              Try Again
            </button>
          </div>
        </div>
      `)}}async function nt(){try{console.log("Making API call to /api/articles...");const e=await y("/api/articles");return console.log("API call successful:",{isArray:Array.isArray(e),length:(e==null?void 0:e.length)||0}),Array.isArray(e)?e:[]}catch(e){throw console.error("Error fetching articles:",e),e.message.includes("fetch")?new Error("Unable to connect to server. Please check if the backend is running."):e.message.includes("JSON")?new Error("Server returned invalid data format."):new Error(`Failed to load articles: ${e.message}`)}}function B(e){const t=document.getElementById("articles-container");if(!t){console.error("Articles container not found in DOM");return}try{if(t.className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 justify-items-start",e.length===0){t.innerHTML=`
        <div class="col-span-full text-center py-12">
          <svg class="mx-auto h-12 w-12 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 12h6m-6-4h6"></path>
          </svg>
          <h3 class="text-lg font-medium text-gray-700 mb-2">No articles found</h3>
          <p class="text-gray-500">Try searching with different keywords</p>
        </div>
      `,document.getElementById("pagination").innerHTML="";return}t.innerHTML="";const o=(window.currentPage-1)*window.articlesPerPage,n=o+window.articlesPerPage,r=e.slice(o,n);console.log(`Rendering ${r.length} articles (page ${window.currentPage})`),r.forEach((s,i)=>{try{const a=document.createElement("div");a.className="w-full max-w-sm bg-white rounded-xl shadow-md overflow-hidden hover:shadow-xl transition-all duration-300 hover:-translate-y-1 border border-gray-100";const l=s.img&&s.img.trim()?s.img:"https://images.unsplash.com/photo-1586953208448-b95a79798f07?w=300&h=200&fit=crop",c=s.article_link&&s.article_link.trim()?s.article_link:"#",d=s.title?s.title.length>60?s.title.substring(0,60)+"...":s.title:"Untitled Article",u=s.article_intro?s.article_intro.length>120?s.article_intro.substring(0,120)+"...":s.article_intro:"No description available";a.innerHTML=`
          <div class="relative overflow-hidden">
            <img src="${l}" alt="${d}" 
                 class="w-full h-48 object-cover transition-transform duration-300 hover:scale-105" 
                 onerror="this.src='https://images.unsplash.com/photo-1586953208448-b95a79798f07?w=300&h=200&fit=crop'">
          </div>
          <div class="p-5">
            <h3 class="text-lg font-bold text-gray-800 mb-3 leading-tight">${d}</h3>
            <p class="text-sm text-gray-600 mb-4 leading-relaxed">${u}</p>
            ${c!=="#"?`<a href="${c}" 
                 class="inline-flex items-center text-sm font-medium text-violet-600 hover:text-violet-800 transition-colors duration-200" 
                 target="_blank" rel="noopener">
                  Read More 
                  <svg class="ml-1 w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                  </svg>
               </a>`:'<span class="text-sm text-gray-400">Link not available</span>'}
          </div>
        `,t.appendChild(a)}catch(a){console.error(`Error rendering article card ${i}:`,a,s)}}),rt(e)}catch(o){console.error("Error in renderArticleCards:",o),t.innerHTML=`
      <div class="col-span-full text-center py-8">
        <p class="text-red-600">Error displaying articles</p>
      </div>
    `}}function rt(e){const t=Math.ceil(e.length/window.articlesPerPage),o=document.getElementById("pagination");if(!o){console.error("Pagination element not found");return}if(t<=1){o.innerHTML="",o.style.paddingBottom="3rem";return}if(o.innerHTML="",o.className="flex flex-wrap justify-center items-center gap-2 mt-8 pb-12",window.currentPage>1){const a=document.createElement("button");a.innerHTML=`
      <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
      </svg>
      <span class="hidden sm:inline">Previous</span>
    `,a.className="inline-flex items-center px-3 py-2 text-sm bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors duration-200",a.addEventListener("click",()=>{window.currentPage--,B(window.filteredArticles)}),o.appendChild(a)}const n=window.innerWidth<640?3:5,r=Math.max(1,window.currentPage-Math.floor(n/2)),s=Math.min(t,r+n-1);if(r>1){const a=D(1);if(o.appendChild(a),r>2){const l=document.createElement("span");l.textContent="...",l.className="px-2 text-gray-500",o.appendChild(l)}}for(let a=r;a<=s;a++){const l=D(a,a===window.currentPage);o.appendChild(l)}if(s<t){if(s<t-1){const l=document.createElement("span");l.textContent="...",l.className="px-2 text-gray-500",o.appendChild(l)}const a=D(t);o.appendChild(a)}if(window.currentPage<t){const a=document.createElement("button");a.innerHTML=`
      <span class="hidden sm:inline">Next</span>
      <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
      </svg>
    `,a.className="inline-flex items-center px-3 py-2 text-sm bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors duration-200",a.addEventListener("click",()=>{window.currentPage++,B(window.filteredArticles)}),o.appendChild(a)}const i=document.createElement("div");i.textContent=`Page ${window.currentPage} of ${t}`,i.className="text-sm text-gray-500 mt-2 w-full text-center sm:w-auto sm:mt-0 sm:ml-4",o.appendChild(i)}function D(e,t=!1){const o=document.createElement("button");return o.textContent=e,o.className=`px-3 py-2 text-sm rounded-lg transition-all duration-200 font-medium ${t?"bg-violet-600 text-white shadow-md":"bg-white text-gray-700 hover:bg-violet-50 hover:text-violet-600 border border-gray-200"}`,o.addEventListener("click",()=>{window.currentPage=e,B(window.filteredArticles)}),o}console.log("historyDetailPresenter.js loaded");async function st(e){if(console.log("renderHistoryDetail called with historyId:",e),!e||e==="undefined"||e==="null"){console.error("Invalid historyId:",e),P("Invalid history ID provided");return}try{fetch("/views/historydetailView.html").then(t=>{if(!t.ok)throw new Error("Failed to load historydetailView.html");return t.text()}).then(t=>{document.getElementById("app").innerHTML=t,it(),at(e)}).catch(t=>{console.error("Error loading history detail view:",t),P(`Failed to load the history detail view: ${t.message}`)})}catch(t){console.error("Error rendering history detail:",t),P(`Error rendering history detail: ${t.message}`)}}function it(){[{selector:'a[href="#dashboard"]',view:"dashboard"},{selector:'a[href="#history"]',view:"history"},{selector:'a[href="#logout"]',view:"logout"}].forEach(({selector:e,view:t})=>{const o=document.querySelector(e);o&&o.addEventListener("click",n=>{n.preventDefault(),t==="logout"?ue():me(t)})})}function ue(){localStorage.clear(),location.reload()}function me(e){switch(e){case"dashboard":x(()=>Promise.resolve().then(()=>ce)).then(t=>t.renderDashboard());break;case"history":x(()=>Promise.resolve().then(()=>pe)).then(t=>t.renderHistory());break;case"logout":ue();break;default:console.warn(`View '${e}' not recognized`)}}async function at(e){try{console.log("Loading history detail for ID:",e);const t=await A(`/api/history/${e}`);t?lt(t):ct()}catch(t){console.error("Error loading history detail:",t),P(`Failed to load history detail: ${t.message}`)}}function lt(e){console.log("Displaying history detail:",e);const t=document.getElementById("percentage"),o=document.getElementById("stress-title"),n=document.getElementById("emotion-badge"),r=document.getElementById("user-input"),s=document.getElementById("analysis-text"),i=document.querySelectorAll(".video-embed"),a=e.stress_percent.toFixed(1);if(t&&(t.textContent=`${a}%`),t&&t.parentElement){const c=t.parentElement;let d;a>66?d="#dc2626":a>33?d="#eab308":d="#16a34a";const u=112,g=8,f=(u-g)/2,v=2*Math.PI*f,k=v,b=v-a/100*v;c.innerHTML=`
      <div class="relative w-28 h-28 flex items-center justify-center">
        <svg class="absolute inset-0 w-full h-full transform -rotate-90" viewBox="0 0 ${u} ${u}">
          <!-- Background circle -->
          <circle
            cx="${u/2}"
            cy="${u/2}"
            r="${f}"
            stroke="#e5e7eb"
            stroke-width="${g}"
            fill="transparent"
          />
          <!-- Progress circle -->
          <circle
            cx="${u/2}"
            cy="${u/2}"
            r="${f}"
            stroke="${d}"
            stroke-width="${g}"
            fill="transparent"
            stroke-dasharray="${k}"
            stroke-dashoffset="${b}"
            stroke-linecap="round"
            class="transition-all duration-1000 ease-out"
          />
        </svg>
        <div class="relative z-10 text-center">
          <div class="text-xl font-bold text-gray-800">${a}%</div>
        </div>
      </div>
    `}if(o){let c="Unknown";if(e.stress_level)switch(e.stress_level.toLowerCase()){case"low":c="Low Stress";break;case"medium":c="Medium Stress";break;case"high":c="High Stress";break;default:c=e.stress_level.charAt(0).toUpperCase()+e.stress_level.slice(1)}o.textContent=c}if(n&&(n.textContent=`Emotion: ${e.emotion||"Unknown"}`,n.className="inline-block bg-violet-800 text-white rounded-full px-3 py-1 text-sm mb-3"),r&&(r.textContent=e.text||"No input provided."),s&&e.feedback){const c=e.feedback.split("Suggestions:");let d=c[0].replace(/^-\s*|\s*-$/g,"").trim();const u=c[1]?c[1].trim():"",g="Why you're getting this result:";d.startsWith(g)&&(d=d.slice(g.length).trim()),s.innerHTML=`
      <strong>Why you're getting this result:</strong> ${d}
      ${u?`<br><br><strong>Suggestions:</strong> ${u}`:""}
    `}else s&&(s.textContent="No feedback provided.");let l=[];if(e.video_link)try{l=JSON.parse(e.video_link),console.log("Parsed video links:",l)}catch(c){console.error("Error parsing video links:",c),l=[]}i.forEach((c,d)=>{const u=l[d];u&&u.trim()!==""?(console.log(`Setting video ${d}:`,u),c.innerHTML=`
        <iframe 
          width="100%" 
          height="100%" 
          src="${u}" 
          frameborder="0" 
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
          allowfullscreen
          class="w-full h-full rounded-lg">
        </iframe>`):(console.log(`No video available for embed ${d}`),c.innerHTML=`
        <div class="flex items-center justify-center text-gray-600 h-full">
          <div class="text-center">
            <svg class="w-8 h-8 mx-auto mb-2 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
            </svg>
            <p class="text-sm">No video available</p>
          </div>
        </div>`)})}function ct(){const e=document.getElementById("app");e&&(e.innerHTML=`
      <div class="max-w-6xl mx-auto px-4 py-8 text-center">
        <div class="text-gray-400 mb-4">
          <svg class="w-16 h-16 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
          </svg>
        </div>
        <p class="text-gray-500 text-lg">No history detail available</p>
        <button onclick="loadView('history')" class="mt-4 px-4 py-2 bg-violet-600 text-white rounded-lg hover:bg-violet-700 transition-colors">
          Back to History
        </button>
      </div>
    `)}function P(e){const t=document.getElementById("app");t&&(t.innerHTML=`
      <div class="max-w-6xl mx-auto px-4 py-8 text-center">
        <div class="text-red-400 mb-4">
          <svg class="w-16 h-16 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 15.5c-.77.833.192 2.5 1.732 2.5z"></path>
          </svg>
        </div>
        <p class="text-red-500 text-lg">${e}</p>
        <button onclick="loadView('history')" class="mt-4 px-4 py-2 bg-violet-600 text-white rounded-lg hover:bg-violet-700 transition-colors">
          Back to History
        </button>
      </div>
    `)}window.loadView=me;function ge(){fetch("views/historyView.html").then(e=>{if(!e.ok)throw new Error("Failed to load historyView.html");return e.text()}).then(e=>{document.getElementById("app").innerHTML=e,console.log("History view loaded, initializing..."),j()}).catch(e=>{console.error("Error loading history view:",e),document.getElementById("app").innerHTML=`
        <div class="p-4 text-center">
          <h2 class="text-xl font-bold text-red-600">Error Loading History</h2>
          <p class="text-gray-600">Failed to load the history view: ${e.message}</p>
        </div>
      `})}class he{constructor(t){this.view=t,this.allHistory=[],this.filteredHistory={}}async loadHistory(){try{this.view.showLoading();const t=await A("/api/history");this.allHistory=t;const o=this.groupFeedbacksByPeriod(t);this.filteredHistory=o,this.view.renderHistory(o),this.setupFilterListener()}catch(t){console.error("Failed to load feedback history:",t),this.view.renderError("Failed to load history data. Please try again.")}}setupFilterListener(){const t=document.getElementById("filterDropdown");t&&t.addEventListener("change",o=>{this.filterHistory(o.target.value)})}groupFeedbacksByPeriod(t){const o=new Date().toLocaleString("en-US",{timeZone:"Asia/Jakarta"}),n=new Date(o);new Date(o).setDate(n.getDate()-1);const r=new Date(o);r.setDate(n.getDate()-n.getDay()+1),r.setHours(0,0,0,0);const s=n.getFullYear(),i=n.getMonth(),a={today:[],thisWeek:[],lastMonth:[],earlierThisYear:[],lastYear:[]};return t.forEach(l=>{let c;if(typeof l.created_at=="string"&&l.created_at.includes(" ")?(c=new Date(l.created_at+" UTC"),c=new Date(c.toLocaleString("en-US",{timeZone:"Asia/Jakarta"}))):c=new Date(new Date(l.created_at).toLocaleString("en-US",{timeZone:"Asia/Jakarta"})),c.getFullYear()===n.getFullYear()&&c.getMonth()===n.getMonth()&&c.getDate()===n.getDate())a.today.push(l);else if(c>=r&&c<=n)a.thisWeek.push(l);else if(c.getFullYear()===s&&c.getMonth()===i-1)a.lastMonth.push(l);else if(c.getFullYear()===s)a.earlierThisYear.push(l);else if(c.getFullYear()===s-1)a.lastYear.push(l);else{const d=c.getFullYear().toString();a[d]||(a[d]=[]),a[d].push(l)}}),a}filterHistory(t){if(console.log("Filtering by:",t),t==="all")this.view.renderHistoryContent(this.filteredHistory);else{const n={};this.filteredHistory[t]&&this.filteredHistory[t].length>0&&(n[t]=this.filteredHistory[t]),this.view.renderHistoryContent(n)}this.setupFilterListener();const o=document.getElementById("filterDropdown");o&&(o.value=t)}getHistoryItem(t){return this.allHistory.find(o=>o.history_id===t)}searchHistory(t){const o=this.allHistory.filter(r=>r.text&&r.text.toLowerCase().includes(t.toLowerCase())),n=this.groupFeedbacksByPeriod(o);this.view.renderHistoryContent(n)}showDetail(t){console.log("showDetail called with historyId:",t),st(t)}}class fe{constructor(){this.container=null,this.presenter=null}showLoading(){const t=document.getElementById("app");t.innerHTML=`
      <main class="max-w-6xl mx-auto px-4 py-8 sm:px-6 lg:px-10">
        <div class="flex justify-center items-center py-12">
          <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-violet-700"></div>
          <span class="ml-3 text-gray-600">Loading your history...</span>
        </div>
      </main>
    `}renderHistory(t){const o=document.getElementById("app");o.innerHTML=`
      <main class="max-w-6xl mx-auto px-4 py-8 sm:px-6 lg:px-10 xl:py-20">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-8">
          <h1 class="text-2xl font-bold text-gray-600">Your History</h1>
          <div class="w-full sm:w-64 lg:w-48">
            <select id="filterDropdown" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-violet-700 focus:border-transparent bg-white text-gray-500 text-sm">
              <option value="all">All Time</option>
              <option value="today">Today</option>
              <option value="thisWeek">This Week</option>
              <option value="lastMonth">Last Month</option>
              <option value="earlierThisYear">Earlier This Year</option>
              <option value="lastYear">Last Year</option>
            </select>
          </div>
        </div>
        <div id="historyContainer"></div>
      </main>
    `,this.renderHistoryContent(t)}renderHistoryContent(t){const o=document.getElementById("historyContainer");if(!o)return;this.container=o,o.innerHTML="";const n=[{key:"today",label:"Today"},{key:"thisWeek",label:"This Week"},{key:"lastMonth",label:"Last Month"},{key:"earlierThisYear",label:"Earlier This Year"},{key:"lastYear",label:"Last Year"},...Object.keys(t).filter(s=>!["today","thisWeek","lastMonth","earlierThisYear","lastYear"].includes(s)).sort((s,i)=>i-s).map(s=>({key:s,label:s}))];let r=!1;n.forEach((s,i)=>{const a=t[s.key];if(a&&a.length>0){r=!0;const l=`history-${s.key.toLowerCase().replace(/\s/g,"-")}`,c=`
          <div class="${i>0?"mt-12":""}">
            <h2 class="text-2xl font-semibold text-gray-600 mb-6">${s.label}</h2>
            <div id="${l}" class="grid gap-4 md:gap-6"></div>
          </div>
        `;o.insertAdjacentHTML("beforeend",c),this.renderSection(l,a)}}),r||(o.innerHTML=`
        <div class="text-center py-12">
          <div class="text-gray-400 mb-4">
            <svg class="w-16 h-16 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
          </div>
          <p class="text-gray-500 text-lg">No history entries found for this period.</p>
          <p class="text-gray-400 text-sm mt-2">Try selecting a different time period or check back later.</p>
        </div>
      `)}renderSection(t,o){const n=document.getElementById(t);if(n){if(n.innerHTML="",o.length===0){n.innerHTML='<p class="text-gray-500 italic">Nothing to show here.</p>';return}o.forEach(r=>{const s=document.createElement("div");s.className="bg-white shadow-md rounded-xl p-6 hover:shadow-lg transition-all duration-200 cursor-pointer border border-gray-100",s.dataset.historyId=r.history_id;const i=Math.round((r.stress_percent||0)*100)/100,a=r.stress_level||"unknown",l=r.emotion||"neutral",c=r.text||"No description",d=new Date(new Date(r.created_at).toLocaleString("en-US",{timeZone:"Asia/Jakarta"}));s.innerHTML=`
        <div class="flex items-center justify-between">
          <div class="flex items-center space-x-4">
            <div class="flex-shrink-0">
              ${this.createDonutChart(i)}
            </div>
            <div class="flex-1 min-w-0">
              <div class="flex flex-wrap items-center gap-2 mb-2">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${this.getStressLevelClass(a)}">
                  ${this.capitalizeFirst(a)} Stress
                </span>
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${this.getEmotionClass(l)}">
                  ${this.capitalizeFirst(l)}
                </span>
              </div>
              <p class="text-sm text-gray-500 mb-2">${this.formatDate(d)}</p>
              <p class="text-gray-700 text-sm line-clamp-2">${c}</p>
            </div>
          </div>
          <div class="flex-shrink-0 ml-4">
            <svg class="w-6 h-6 text-violet-700 cursor-pointer detail-button" fill="none" stroke="currentColor" viewBox="0 0 24 24" data-history-id="${r.history_id}">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
          </div>
        </div>
      `,n.appendChild(s)}),this.attachDetailButtonListeners(t)}}attachDetailButtonListeners(t){const o=document.getElementById(t);o&&o.querySelectorAll(".detail-button").forEach(n=>{n.addEventListener("click",r=>{r.stopPropagation();const s=n.dataset.historyId;console.log("Detail button clicked for history ID:",s),this.presenter.showDetail(s)})})}renderError(t){const o=document.getElementById("app");o.innerHTML=`
      <main class="max-w-6xl mx-auto px-4 py-8 sm:px-6 lg:px-10">
        <div class="text-center py-12">
          <div class="text-red-400 mb-4">
            <svg class="w-16 h-16 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 15.5c-.77.833.192 2.5 1.732 2.5z"></path>
            </svg>
          </div>
          <p class="text-red-500 text-lg">${t}</p>
          <button onclick="window.location.reload()" class="mt-4 px-4 py-2 bg-violet-600 text-white rounded-lg hover:bg-violet-700 transition-colors">
            Try Again
          </button>
        </div>
      </main>
    `}createDonutChart(t){const o=2*Math.PI*28,n=o,r=o-t/100*o;let s="#10b981";return t>33&&t<=66?s="#f59e0b":t>66&&(s="#ef4444"),`
      <div class="relative" style="width: 64px; height: 64px;">
        <svg width="64" height="64" class="transform -rotate-90">
          <circle cx="32" cy="32" r="28" fill="none" stroke="#e5e7eb" stroke-width="4" />
          <circle cx="32" cy="32" r="28" fill="none" stroke="${s}" stroke-width="4" stroke-linecap="round" stroke-dasharray="${n}" stroke-dashoffset="${r}" class="transition-all duration-300 ease-in-out" />
        </svg>
        <div class="absolute inset-0 flex items-center justify-center">
          <span class="text-gray-700 font-bold text-xs">${t.toFixed(1)}%</span>
        </div>
      </div>
    `}getStressLevelClass(t){return{Low:"bg-green-100 text-green-800",Medium:"bg-yellow-200 text-yellow-800",High:"bg-red-100 text-red-800"}[t]||"bg-gray-100 text-gray-800"}getEmotionClass(t){return{Overwhelmed:"bg-blue-100 text-blue-800",Lonely:"bg-violet-100 text-violet-800",Depressed:"bg-rose-100 text-rose-800",Panicked:"bg-purple-100 text-purple-800",Anxious:"bg-cyan-100 text-cyan-800"}[t]||"bg-gray-100 text-gray-800"}capitalizeFirst(t){return t?t.charAt(0).toUpperCase()+t.slice(1):""}formatDate(t){const o=new Date(new Date().toLocaleString("en-US",{timeZone:"Asia/Jakarta"})),n=Math.abs(o-t),r=Math.ceil(n/(1e3*60*60*24));return r===1?"Today at "+t.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):r===2?"Yesterday at "+t.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):r<=7?t.toLocaleDateString([],{weekday:"long"})+" at "+t.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):t.toLocaleDateString([],{month:"short",day:"numeric",year:"numeric"})}}const T=new fe;T.presenter=new he(T);function j(){T.presenter.loadHistory()}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{j()}):j();const pe=Object.freeze(Object.defineProperty({__proto__:null,HistoryPresenter:he,HistoryView:fe,renderHistory:ge,view:T},Symbol.toStringTag,{value:"Module"}));let h=null;function dt(){console.log("renderAccount called"),console.log("isLoggedIn:",sessionStorage.getItem("isLoggedIn")),console.log("user:",sessionStorage.getItem("user")),console.log("token:",sessionStorage.getItem("token"));const e=sessionStorage.getItem("isLoggedIn")==="true";if(console.log("isLoggedIn check result:",e),!e){console.log("Not logged in, redirecting to login"),window.loadView("login");return}fetch("views/account.html").then(t=>{if(!t.ok)throw new Error("Failed to load account.html");return t.text()}).then(t=>{console.log("Account HTML loaded successfully"),document.getElementById("app").innerHTML=t;const o=JSON.parse(sessionStorage.getItem("user")||"{}");if(o&&o.name){h=o;const n=document.getElementById("dropdown-username"),r=document.getElementById("dropdown-email"),s=document.getElementById("username-field");n&&(n.textContent=o.name),r&&(r.textContent=o.email),s&&(s.value=o.name),H()}try{ut(),ft(),new URLSearchParams(window.location.search).get("success")==="true"&&(q("Profile updated successfully"),window.history.replaceState({},document.title,window.location.pathname))}catch(n){console.error("Error initializing account page:",n),E("Failed to load account information")}}).catch(t=>{console.error("Error loading account view:",t)})}async function ut(){try{const e=await y("/api/profile",{method:"GET"});if(!e||!e.user)throw new Error("Failed to fetch profile");h=e.user,sessionStorage.setItem("user",JSON.stringify(h)),H()}catch(e){console.error("Error fetching profile:",e),E("Failed to fetch latest profile data. Using cached data."),H()}}function mt(e){const t=/[a-zA-Z]/.test(e),o=/\d/.test(e),n=/[!@#$%^&*(),.?":{}|<>]/.test(e);return e.length<8||!(t&&o&&n)?{isValid:!1,message:"Password must be at least 8 characters long and include a mix of letters, numbers, and symbols."}:{isValid:!0,message:""}}function W(e){var t;const o="https://via.placeholder.com/150x150/e2e8f0/64748b?text=User";try{if(!(h!=null&&h.img)){e.src=o;return}if(typeof h.img=="string"){if(h.img.startsWith("http")||h.img.startsWith("data:image/")){e.src=h.img;return}if(h.img.startsWith("\\x"))try{const n=((t=h.img.substring(2).match(/.{2}/g))==null?void 0:t.map(r=>String.fromCharCode(parseInt(r,16))).join(""))||"";if(n.startsWith("http")){e.src=n;return}}catch(n){console.error("Error decoding hex string:",n)}}if(h.img&&typeof h.img=="object"&&h.img.data){const n=ht(h.img.data);if(n){e.src=n;return}}e.src=o,e.onerror=()=>{console.warn("Failed to load profile image, using default"),e.src=o,e.onerror=null}}catch(n){console.error("Error displaying profile image:",n),e.src=o}}function H(){const e=document.getElementById("username");e&&(e.textContent=(h==null?void 0:h.name)||"User");const t=document.getElementById("profile-image-preview");t&&W(t);const o=document.getElementById("profile-image");o&&W(o);const n=document.getElementById("username-field"),r=document.getElementById("email");n&&(n.value=(h==null?void 0:h.name)||""),r&&(r.value=(h==null?void 0:h.email)||"")}async function gt(e){var t,o,n;e.preventDefault(),wt();const r=document.getElementById("username-field")||document.getElementById("username"),s=r?r.value.trim():"",i=((t=document.getElementById("current-password"))==null?void 0:t.value)||"",a=((o=document.getElementById("new-password"))==null?void 0:o.value)||"",l=((n=document.getElementById("confirm-password"))==null?void 0:n.value)||"",c=document.getElementById("profile-image-input");if(!s){C("username","Username is required");return}if(a||i||l){if(!i){C("current-password","Current password is required to change password");return}if(!a){C("new-password","New password is required");return}const d=mt(a);if(!d.isValid){C("new-password",d.message);return}if(a!==l){C("confirm-password","Passwords do not match");return}}ye();try{const d=sessionStorage.getItem("token"),u=new FormData;u.append("name",s),a&&i&&(u.append("currentPassword",i),u.append("newPassword",a)),c&&c.files.length>0&&u.append("profileImage",c.files[0]);const g=await fetch(`${Y}/api/profile`,{method:"PUT",headers:{Authorization:`Bearer ${d}`},body:u});if(!g.ok){let S=await g.text();throw console.error("Update profile failed:",g.status,S),new Error(`Failed to update profile: ${g.status} - ${S}`)}const f=g.headers.get("content-type");if(!f||!f.includes("application/json")){let S=await g.text();throw console.error("Non-JSON response:",S),new Error("Non-JSON response from server")}h=(await g.json()).user,sessionStorage.setItem("user",JSON.stringify(h)),H();const v=document.getElementById("current-password"),k=document.getElementById("new-password"),b=document.getElementById("confirm-password");v&&(v.value=""),k&&(k.value=""),b&&(b.value=""),q()}catch(d){console.error("Error updating profile:",d),E(d.message||"Failed to update profile")}finally{we()}}function ht(e){try{if(!e)return null;let t="",o;if(e instanceof ArrayBuffer)o=new Uint8Array(e);else if(e instanceof Uint8Array)o=e;else if(Array.isArray(e))o=new Uint8Array(e);else return console.warn("Unknown binary data format:",typeof e),null;const n=8192;for(let r=0;r<o.length;r+=n){const s=o.subarray(r,Math.min(r+n,o.length));t+=String.fromCharCode.apply(null,s)}return"data:image/jpeg;base64,"+btoa(t)}catch(t){return console.error("Error converting binary to base64:",t),null}}function ft(){const e=document.querySelector(".nav-links a[href='#']");e&&e.addEventListener("click",a=>{a.preventDefault(),window.logout&&window.logout()});const t=document.getElementById("settings-form");t&&t.addEventListener("submit",gt);const o=document.getElementById("profile-image-input");o&&o.addEventListener("change",pt),["current-password","new-password","confirm-password"].forEach(a=>{const l=document.querySelector(`button[data-toggle="${a}"]`);l&&l.addEventListener("click",()=>yt(a))});const n=document.getElementById("back-button");n&&n.addEventListener("click",()=>{window.history.back()});const r=document.getElementById("delete-account-btn");r&&r.addEventListener("click",()=>{document.getElementById("delete-modal").classList.remove("hidden")});const s=document.getElementById("confirm-delete-btn");s&&s.addEventListener("click",vt);const i=document.getElementById("cancel-delete-btn");i&&i.addEventListener("click",ve)}function pt(e){const t=e.target.files[0];if(!t)return;if(!t.type.startsWith("image/")){E("Please select an image file"),e.target.value="";return}if(t.size>5*1024*1024){E("Image size should be less than 5MB"),e.target.value="";return}const o=new FileReader;o.onload=n=>{const r=document.getElementById("profile-image-preview");r&&(r.src=n.target.result)},o.onerror=()=>{E("Error reading image file"),e.target.value=""},o.readAsDataURL(t)}function yt(e){const t=document.getElementById(e),o=document.querySelector(`button[data-toggle="${e}"] i`);t&&o&&(t.type==="password"?(t.type="text",o.classList.remove("fa-eye"),o.classList.add("fa-eye-slash")):(t.type="password",o.classList.remove("fa-eye-slash"),o.classList.add("fa-eye")))}function wt(){document.querySelectorAll('[id$="-error"]').forEach(e=>{e.classList.add("hidden"),e.textContent=""})}function C(e,t){const o=document.getElementById(`${e}-error`);o&&(o.textContent=t,o.classList.remove("hidden"))}function E(e){const t=document.getElementById("alert-modal"),o=document.getElementById("alert-icon"),n=document.getElementById("alert-title"),r=document.getElementById("alert-message"),s=document.getElementById("alert-close-btn");t&&o&&n&&r&&s&&(o.innerHTML='<i class="fas fa-exclamation-circle text-red-500 text-2xl"></i>',n.textContent="Error",r.textContent=e,t.classList.remove("hidden"),s.onclick=()=>{t.classList.add("hidden")})}function q(e="Profile updated successfully"){const t=document.getElementById("alert-modal"),o=document.getElementById("alert-icon"),n=document.getElementById("alert-title"),r=document.getElementById("alert-message"),s=document.getElementById("alert-close-btn");t&&o&&n&&r&&s&&(o.innerHTML='<i class="fas fa-check-circle text-green-500 text-2xl"></i>',n.textContent="Success",r.textContent=e,t.classList.remove("hidden"),s.onclick=()=>{t.classList.add("hidden")})}function ye(){const e=document.getElementById("loading-spinner");e&&e.classList.remove("hidden");const t=document.querySelector('#settings-form button[type="submit"]');t&&(t.disabled=!0,t.textContent="Updating...")}function we(){const e=document.getElementById("loading-spinner");e&&e.classList.add("hidden");const t=document.querySelector('#settings-form button[type="submit"]');t&&(t.disabled=!1,t.textContent="Save Changes")}function ve(){document.getElementById("delete-modal").classList.add("hidden")}async function vt(){ye();try{const e=await y("/api/profile",{method:"DELETE"});if(!e||!e.message)throw new Error("Invalid response from server");console.log("Account deleted successfully:",e.message),sessionStorage.removeItem("isLoggedIn"),sessionStorage.removeItem("user"),sessionStorage.removeItem("token"),q("Account deleted successfully"),setTimeout(()=>{window.loadView("login")},2e3)}catch(e){let t="Failed to delete account. Please try again or contact support at support@himo.com.";if(e.message.includes("HTTP 500")&&e.message.includes("details"))try{t=JSON.parse(e.message.split("HTTP 500 - ")[1]).details||t}catch(o){console.warn("Failed to parse error details:",o)}console.error("Error deleting account:",{message:e.message,stack:e.stack,response:e.message.includes("HTTP 500")?e.message:null}),E(t)}finally{ve(),we()}}window.openInNewTab=function(e){const t=window.open(window.location.origin+window.location.pathname+"#"+e,"_blank");t&&t.focus()};function bt(e,t){var o;const n="https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_960_720.png";try{if(!t){e.src=n;return}if(typeof t=="string"){if(t.startsWith("http")||t.startsWith("data:image/")){e.src=t;return}if(t.startsWith("\\x"))try{const r=((o=t.substring(2).match(/.{2}/g))==null?void 0:o.map(s=>String.fromCharCode(parseInt(s,16))).join(""))||"";if(r.startsWith("http")){e.src=r;return}}catch(r){console.error("Error decoding hex string:",r)}}if(t&&typeof t=="object"&&t.data){const r=xt(t.data);if(r){e.src=r;return}}e.src=n,e.onerror=()=>{e.src=n,e.onerror=null}}catch(r){console.error("Error displaying profile image:",r),e.src=n}}function xt(e){try{if(!e)return null;let t="",o;if(e instanceof ArrayBuffer)o=new Uint8Array(e);else if(e instanceof Uint8Array)o=e;else if(Array.isArray(e))o=new Uint8Array(e);else return console.warn("Unknown binary data format:",typeof e),null;const n=8192;for(let r=0;r<o.length;r+=n){const s=o.subarray(r,Math.min(r+n,o.length));t+=String.fromCharCode.apply(null,s)}return"data:image/jpeg;base64,"+btoa(t)}catch(t){return console.error("Error converting binary to base64:",t),null}}window.updateNavbar=async function(){const e=document.getElementById("navbar-container");if(!e){console.error("Navbar container not found");return}const t=window.isUserLoggedIn(),o=t?"views/navbarLogin.html":"views/navbarNotLogin.html";try{const n=await fetch(o);if(!n.ok)throw new Error(`Failed to load navbar: ${o}`);const r=await n.text();e.innerHTML=r;const s=document.getElementById("menu-toggle"),i=document.getElementById("navbar-menu");if(s&&i&&(s.removeEventListener("click",window.toggleMobileMenu),window.toggleMobileMenu=()=>{i.classList.toggle("hidden")},s.addEventListener("click",window.toggleMobileMenu)),t){const a=window.getCurrentUser();a&&_(a),Et().catch(console.error)}}catch(n){console.error("Error updating navbar:",n)}};function _(e){if(!e){console.warn("No user data provided to updateNavbarUI");return}const t=document.getElementById("profile-image"),o=document.getElementById("dropdown-username"),n=document.getElementById("dropdown-email");t&&bt(t,e.img),o&&(o.textContent=e.name||"User"),n&&(n.textContent=e.email||"")}async function Et(){const e=sessionStorage.getItem("token");if(e)try{const t=await fetch("/api/profile",{headers:{Authorization:`Bearer ${e}`}});if(t.ok){const o=await t.json();sessionStorage.setItem("user",JSON.stringify(o.user)),_(o.user)}}catch(t){console.error("Error fetching user profile:",t)}}window.loadView=function(e){e||(e=window.location.hash.substring(1)||(sessionStorage.getItem("isLoggedIn")==="true"?"curhat":"home")),e!=="home"?window.location.hash=e:window.location.hash="";const t=sessionStorage.getItem("isLoggedIn")==="true";console.log(`Attempting to load view: ${e}`),console.log(`isLoggedIn: ${t}`),e==="signup"||e==="login"||e==="forgetpassword"||e==="terms"||e==="privacy"?document.body.classList.add("no-navbar"):document.body.classList.remove("no-navbar"),e==="signup"||e==="login"||e==="dashboard"||e==="account"||e==="history"||e==="curhat"||e==="feedback"||e==="articles"||e==="forgetpassword"||e==="terms"||e==="privacy"?document.body.classList.add("contact"):document.body.classList.remove("contact");let o;switch(e){case"home":o=M;break;case"login":o=I;break;case"signup":o=Be;break;case"articles":o=Qe;break;case"curhat":o=t?R:I;break;case"feedback":o=t?Z:I;break;case"dashboard":o=t?O:I;break;case"history":o=t?ge:I;break;case"account":o=dt;break;case"forgetpassword":o=We;break;case"terms":o=renderTerms;break;case"privacy":o=renderPrivacy;break;default:o=M}if(o)try{o()}catch(n){console.error(`Error rendering view ${e}:`,n),I()}else console.error(`No render function found for view ${e}`),M();window.updateNavbar().then(()=>{if(t){const n=window.getCurrentUser();n&&_(n)}}).catch(n=>{console.error("Error updating navbar:",n)})};window.login=async function(e,t){sessionStorage.setItem("isLoggedIn","true"),e&&sessionStorage.setItem("user",JSON.stringify(e)),t&&sessionStorage.setItem("token",t),console.log("User logged in, isLoggedIn set to true"),console.log("User data:",e),_(e),await window.updateNavbar(),loadView("curhat")};window.logout=function(){sessionStorage.removeItem("isLoggedIn"),sessionStorage.removeItem("user"),sessionStorage.removeItem("token"),console.log("User logged out"),window.updateNavbar(),loadView("home")};window.getCurrentUser=function(){const e=sessionStorage.getItem("user");return e?JSON.parse(e):null};window.getAuthToken=function(){return sessionStorage.getItem("token")};window.isUserLoggedIn=function(){return sessionStorage.getItem("isLoggedIn")==="true"};window.addEventListener("DOMContentLoaded",()=>{const e=sessionStorage.getItem("isLoggedIn")==="true";console.log(`DOMContentLoaded: isLoggedIn = ${e}`),loadView(e?"curhat":"home")});
