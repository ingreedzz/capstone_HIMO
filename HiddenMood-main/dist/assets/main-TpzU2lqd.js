(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))r(n);new MutationObserver(n=>{for(const s of n)if(s.type==="childList")for(const i of s.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&r(i)}).observe(document,{childList:!0,subtree:!0});function o(n){const s={};return n.integrity&&(s.integrity=n.integrity),n.referrerPolicy&&(s.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?s.credentials="include":n.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function r(n){if(n.ep)return;n.ep=!0;const s=o(n);fetch(n.href,s)}})();function T(){return fetch("views/homeView.html").then(e=>e.text()).then(e=>{document.getElementById("app").innerHTML=e})}const Ee=Object.freeze(Object.defineProperty({__proto__:null,renderHome:T},Symbol.toStringTag,{value:"Module"})),Z="https://capstone-himo.vercel.app/api",ke=["/api/forgot-password/request","/api/forgot-password/verify","/api/forgot-password/reset"];async function x(e,t={}){const o=Z,r=sessionStorage.getItem("token"),n={"Content-Type":"application/json",...ke.includes(e)?{}:r?{Authorization:`Bearer ${r}`}:{},...t.headers||{}},s=`${o}${e}`;try{console.log(`API Call: ${t.method||"GET"} ${s}`);const i=await fetch(s,{...t,headers:n});if(!i.ok){let c="";try{c=await i.text()}catch(l){c=`Failed to read error response: ${l.message}`}throw console.error(`API Call failed for ${e}: HTTP ${i.status} - ${c}`),new Error(`HTTP ${i.status} - ${c}`)}const d=i.headers.get("content-type");if(d&&d.includes("application/json"))return await i.json();{const c=await i.text();return console.warn(`Non-JSON response for ${e}:`,c),c}}catch(i){throw console.error("API Call failed for",e,":",i),i}}async function H(e,t={}){const o=sessionStorage.getItem("token");if(!o)throw new Error("No authentication token found. Please log in.");const r={...t.headers||{},Authorization:`Bearer ${o}`};return x(e,{...t,headers:r})}function I(){fetch("views/loginView.html").then(e=>e.text()).then(e=>{document.getElementById("app").innerHTML=e,Le()}).catch(e=>{console.error("Error loading login view:",e),document.getElementById("app").innerHTML="<p>Error loading login page</p>"})}function Le(){const e=document.getElementById("loginButton"),t=document.getElementById("errorMessage");if(!e||!t){console.error("Login elements not found");return}function o(i){t.textContent=i,t.style.display="block"}function r(){t.textContent="",t.style.display="none"}e.addEventListener("click",async i=>{var l,a;i.preventDefault(),r();const d=(l=document.getElementById("loginEmail"))==null?void 0:l.value.trim(),c=(a=document.getElementById("loginPassword"))==null?void 0:a.value.trim();if(!d||!c){o("Please fill in all fields.");return}try{e.disabled=!0,e.textContent="Logging in...";const u=await x("/api/auth/login",{method:"POST",body:JSON.stringify({email:d,password:c})});u.token&&u.user&&(window.login&&window.login(u.user,u.token),await Ie(),await window.updateNavbar(),window.loadView("dashboard")),r()}catch(u){console.error("Login error:",u),o(u.message)}finally{e.disabled=!1,e.textContent="Log In"}});const n=document.getElementById("signupLink");n&&n.addEventListener("click",i=>{i.preventDefault(),window.loadView&&window.loadView("signup")});const s=document.getElementById("forgotPasswordLink");s&&s.addEventListener("click",i=>{i.preventDefault(),window.loadView&&window.loadView("forgetpassword")})}async function Ie(){const e=sessionStorage.getItem("token");if(!e){console.warn("No token found, skipping profile fetch");return}try{const t=await x("/api/auth/profile",{method:"GET",headers:{Authorization:`Bearer ${e}`}});if(t.user){const o=t.user;sessionStorage.setItem("user",JSON.stringify(o)),q(o)}}catch(t){console.error("Error fetching user profile:",t);const o=JSON.parse(sessionStorage.getItem("user")||"{}");o&&q(o)}}function Be(e,t){var r;const o="https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_960_720.png";try{if(!(t!=null&&t.img)){e.src=o;return}if(typeof t.img=="string"){if(t.img.startsWith("http")||t.img.startsWith("data:image/")){e.src=t.img;return}if(t.img.startsWith("\\x"))try{const s=((r=t.img.substring(2).match(/.{2}/g))==null?void 0:r.map(i=>String.fromCharCode(parseInt(i,16))).join(""))||"";if(s.startsWith("http")){e.src=s;return}}catch(n){console.error("Error decoding hex string:",n)}}if(t.img&&typeof t.img=="object"&&t.img.data){const n=Se(t.img.data);if(n){e.src=n;return}}e.src=o,e.onerror=()=>{console.warn("Failed to load profile image, using default"),e.src=o,e.onerror=null}}catch(n){console.error("Error displaying profile image:",n),e.src=o}}function Se(e){try{if(!e)return null;let t="",o;if(e instanceof ArrayBuffer)o=new Uint8Array(e);else if(e instanceof Uint8Array)o=e;else if(Array.isArray(e))o=new Uint8Array(e);else return console.warn("Unknown binary data format:",typeof e),null;const r=8192;for(let n=0;n<o.length;n+=r){const s=o.subarray(n,Math.min(n+r,o.length));t+=String.fromCharCode.apply(null,s)}return"data:image/jpeg;base64,"+btoa(t)}catch(t){return console.error("Error converting binary to base64:",t),null}}function q(e){if(!e){console.warn("No user data provided to updateNavbarUI");return}const t=document.getElementById("profile-image"),o=document.getElementById("dropdown-username"),r=document.getElementById("dropdown-email");t&&Be(t,e),o&&(o.textContent=e.name||"User"),r&&(r.textContent=e.email||"")}function Ce(){fetch("views/signupView.html").then(e=>e.text()).then(e=>{document.getElementById("app").innerHTML=e,Pe()}).catch(e=>{console.error("Error loading signup view:",e),document.getElementById("app").innerHTML="<p>Error loading signup page</p>"})}function Pe(){const e=document.getElementById("signupButton"),t=document.getElementById("errorMessage");if(!e||!t){console.error("Signup elements not found");return}function o(s){t.textContent=s,t.style.display="block"}function r(){t.textContent="",t.style.display="none"}e.addEventListener("click",async s=>{var m,p,h,w,v;s.preventDefault(),r();const i=(m=document.getElementById("signupName"))==null?void 0:m.value.trim(),d=(p=document.getElementById("signupEmail"))==null?void 0:p.value.trim(),c=(h=document.getElementById("signupPassword"))==null?void 0:h.value.trim(),l=(w=document.getElementById("signupConfirmPassword"))==null?void 0:w.value.trim(),a=(v=document.getElementById("termsCheckbox"))==null?void 0:v.checked;if(!i||!d||!c||!l){o("Please fill in all fields.");return}if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(d)){o("Please enter a valid email address.");return}if(c!==l){o("Passwords do not match.");return}if(!a){o("You must agree to the Terms & Privacy Policy.");return}try{e.disabled=!0,e.textContent="Creating Account...";const L=await x("/api/auth/register",{method:"POST",body:JSON.stringify({name:i,email:d,password:c})});r(),window.loadView&&window.loadView("login")}catch(L){console.error("Registration error:",L),o(L.message)}finally{e.disabled=!1,e.textContent="Sign Up"}});const n=document.getElementById("loginLink");n&&n.addEventListener("click",s=>{s.preventDefault(),window.loadView&&window.loadView("login")})}function G(){fetch("views/curhat.html").then(e=>{if(!e.ok)throw new Error("Failed to load curhat.html");return e.text()}).then(e=>{document.getElementById("app").innerHTML=e;const t=document.getElementById("username"),r=JSON.parse(sessionStorage.getItem("user")||"{}").name||"User";t&&(t.textContent=r);const n=document.querySelector(".nav-links a[href='#']");n&&n.addEventListener("click",d=>{d.preventDefault(),window.logout&&window.logout()});const s=document.getElementById("submitCurhat"),i=document.getElementById("curhatInput");if(document.getElementById("result"),!s||!i){console.warn("Required form elements not found in curhat.html.");return}s.addEventListener("click",async()=>{const d=i.value.trim(),l=JSON.parse(sessionStorage.getItem("user")||"{}").user_id||null;if(!d){alert("Please enter your text.");return}if(d.length<50){alert("Please enter at least 50 characters.");return}console.log("Submitting text:",d.substring(0,50)+"..."),console.log("User ID:",l),Te();try{const a=await x("/api/curhat",{method:"POST",headers:{"Content-Type":"application/json",...sessionStorage.getItem("token")&&{Authorization:`Bearer ${sessionStorage.getItem("token")}`}},body:JSON.stringify({text:d,user_id:l})});if(console.log("Backend Response received:",a),!a||typeof a!="object")throw new Error("Invalid response format from server");const u={user_input:d,predicted_emotion:a.predicted_emotion||{label:"neutral"},predicted_stress:a.predicted_stress||{label:"medium"},stress_level:a.stress_level||{stress_level:50},analysis:a.analysis||"Analysis completed successfully.",keywords:a.keywords||[],recommended_videos:a.recommended_videos||{recommendations:[]},timestamp:new Date().toISOString(),saved_to_history:a.saved_to_history||!1};console.log("Enhanced result object:",u),sessionStorage.setItem("curhatResult",JSON.stringify(u)),i.value="",window.loadView?(console.log("Navigating to feedback view"),window.loadView("feedback")):console.error("window.loadView function not found")}catch(a){console.error("Error occurred:",a);let u="Failed to process your submission. ";a.message.includes("Failed to fetch")||a.message.includes("NetworkError")?u+="Please check if your backend server is running on localhost:5001.":a.message.includes("timeout")?u+="The request timed out. The ML API might be slow to respond. Please try again.":a.message.includes("ML API")?u+="There was an issue with the ML analysis service. Please try again later.":u+=`Details: ${a.message}`,alert(u)}finally{$e()}})}).catch(e=>{console.error("Error loading curhat view:",e)})}function Te(){const e=document.getElementById("spinner");e&&e.classList.remove("hidden");const t=document.getElementById("submitCurhat");t&&(t.disabled=!0,t.textContent="Processing...")}function $e(){const e=document.getElementById("spinner");e&&e.classList.add("hidden");const t=document.getElementById("submitCurhat");t&&(t.disabled=!1,t.textContent="Submit")}const Me=Object.freeze(Object.defineProperty({__proto__:null,renderCurhat:G},Symbol.toStringTag,{value:"Module"})),Ae="modulepreload",_e=function(e,t){return new URL(e,t).href},W={},E=function(t,o,r){let n=Promise.resolve();if(o&&o.length>0){let i=function(a){return Promise.all(a.map(u=>Promise.resolve(u).then(m=>({status:"fulfilled",value:m}),m=>({status:"rejected",reason:m}))))};const d=document.getElementsByTagName("link"),c=document.querySelector("meta[property=csp-nonce]"),l=(c==null?void 0:c.nonce)||(c==null?void 0:c.getAttribute("nonce"));n=i(o.map(a=>{if(a=_e(a,r),a in W)return;W[a]=!0;const u=a.endsWith(".css"),m=u?'[rel="stylesheet"]':"";if(!!r)for(let w=d.length-1;w>=0;w--){const v=d[w];if(v.href===a&&(!u||v.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${a}"]${m}`))return;const h=document.createElement("link");if(h.rel=u?"stylesheet":Ae,u||(h.as="script"),h.crossOrigin="",h.href=a,l&&h.setAttribute("nonce",l),document.head.appendChild(h),u)return new Promise((w,v)=>{h.addEventListener("load",w),h.addEventListener("error",()=>v(new Error(`Unable to preload CSS for ${a}`)))})}))}function s(i){const d=new Event("vite:preloadError",{cancelable:!0});if(d.payload=i,window.dispatchEvent(d),!d.defaultPrevented)throw i}return n.then(i=>{for(const d of i||[])d.status==="rejected"&&s(d.reason);return t().catch(s)})};function K(){fetch("views/feedbackView.html").then(e=>{if(!e.ok)throw new Error("Failed to load feedbackView.html");return e.text()}).then(e=>{document.getElementById("app").innerHTML=e;const t=localStorage.getItem("username")||"User",o=document.getElementById("username");o&&(o.textContent=t),He(),De()}).catch(e=>{console.error("Error loading feedback view:",e)})}function He(){[{selector:'a[href="#dashboard"]',view:"dashboard"},{selector:'a[href="#history"]',view:"history"},{selector:'a[href="#logout"]',view:"logout"}].forEach(({selector:t,view:o})=>{const r=document.querySelector(t);r&&r.addEventListener("click",n=>{n.preventDefault(),o==="logout"?Q():Ne(o)})})}function Q(){localStorage.clear(),location.reload()}function Ne(e){switch(e){case"dashboard":E(()=>Promise.resolve().then(()=>ue),void 0,import.meta.url).then(t=>t.renderDashboard());break;case"history":E(()=>Promise.resolve().then(()=>we),void 0,import.meta.url).then(t=>t.renderHistory());break;case"logout":Q();break;default:console.warn(`View '${e}' tidak dikenali`)}}function De(){const e=JSON.parse(sessionStorage.getItem("curhatResult"));if(!e){console.warn("No feedback result found in sessionStorage.");return}Fe(e),Ue(e),Oe(e)}function Fe(e){var i,d,c,l;const t=document.getElementById("percentage"),o=document.querySelector(".result-card .flex > :first-child");if(t&&o){const a=((i=e.stress_level)==null?void 0:i.stress_level)||0;t.textContent=`${a}%`;const u=50,m=2*Math.PI*u,p=m-a/100*m;o.innerHTML=`
      <svg width="120" height="120" viewBox="0 0 120 120" class="transform -rotate-90">
        <circle cx="60" cy="60" r="${u}" fill="none" stroke="#e5e7eb" stroke-width="20" />
        <circle cx="60" cy="60" r="${u}" fill="none" stroke="url(#gradient)" stroke-width="20" stroke-dasharray="${m}" stroke-dashoffset="${p}" />
        <defs>
          <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" style="stop-color:#6b21a8;" />
            <stop offset="100%" style="stop-color:#a78bfa;" />
          </linearGradient>
        </defs>
      </svg>
      <div class="absolute inset-0 flex items-center justify-center text-violet-800 font-bold text-xl">
        <span id="percentage">${a}%</span>
      </div>
    `,o.classList.add("relative"),o.style.width="120px",o.style.height="120px"}const r=document.getElementById("stress-title");r&&(r.textContent=((d=e.predicted_stress)==null?void 0:d.label)||"Unknown");const n=document.getElementById("emotion-badge");n&&(n.textContent=`Emotion: ${((c=e.predicted_emotion)==null?void 0:c.label)||"Unknown"}`);const s=document.querySelectorAll(".video-box .video-embed");(l=e.recommended_videos)!=null&&l.recommendations&&s.forEach((a,u)=>{const m=e.recommended_videos.recommendations[u];if(!m){a.innerHTML='<p class="text-gray-500 italic">Video unavailable.</p>';return}const p=m.split("/embed/")[1];if(!p){a.innerHTML='<p class="text-gray-500 italic">Video unavailable.</p>';return}a.innerHTML=`
        <iframe 
          src="https://www.youtube.com/embed/${p}" 
          frameborder="0" 
          allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" 
          allowfullscreen 
          class="w-full h-full rounded-lg">
        </iframe>`})}function Ue(e){const t=document.getElementById("user-input");t&&(t.textContent=e.user_input||"No input provided.")}function Oe(e){const t=document.querySelector(".reason-box");if(t&&e.analysis){const o=t.querySelector("p");if(o){const n=e.analysis.split("Suggestions:");let s=n[0].replace(/^-\s*|\s*-$/g,"").trim();const i=n[1]?n[1].trim():"",d="Why you're getting this result:";s.startsWith(d)&&(s=s.slice(d.length).trim()),o.innerHTML=`
        <strong>Why you're getting this result:</strong> ${s}
        ${i?`<br><br><strong>Suggestions:</strong> ${i}`:""}
      `}const r=document.getElementById("keyword-list");r&&r.remove()}}class je{async getFeedbackHistory(){try{const t=await fetch("http://localhost:5001/api/submissions");if(!t.ok)throw new Error("Failed to fetch feedback history");return await t.json()}catch(t){return console.error(t),[]}}}const Ve=Object.freeze(Object.defineProperty({__proto__:null,FeedbackPresenter:je,renderFeedback:K},Symbol.toStringTag,{value:"Module"}));function O(){fetch("views/dashboardView.html").then(e=>{if(!e.ok)throw new Error("Failed to load dashboardView.html");return e.text()}).then(e=>{document.getElementById("app").innerHTML=e,Re().then(()=>{Ye(),X()})}).catch(e=>{console.error("Error loading dashboard:",e),V("Failed to load dashboard. Please try again.")})}function Re(){return new Promise((e,t)=>{if(window.Chart){e();return}const o=document.createElement("script");o.src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js",o.onload=e,o.onerror=t,document.head.appendChild(o)})}const j={anxious:"😰",depressed:"😔",overwhelmed:"😩",panicked:"😨",lonely:"😐"};let g={averageStress:0,stressHistory:[],emotionCounts:{},latestEmotion:"neutral",recentPredictions:[],tips:[],totalSessions:0,weeklyStressLevel:"",avgMood:"",recentActivity:[]},b={};async function X(){try{ce(),await Promise.all([ee(),te()]),await oe(),ne(),ze(),re(),se(),ie(),ae(),le(),qe(),We(),M()}catch(e){console.error("Error initializing dashboard:",e),M(),V("Failed to load dashboard data. Please refresh the page.")}}async function ee(){try{const e=Je(),t=await H(`/api/dashboard/summary?days=${e}`,"GET");g.averageStress=t.averageStress||0,g.emotionCounts=t.emotionCounts||{},g.stressHistory=t.stressHistory||[],g.latestEmotion=t.latestEmotion||"neutral",g.totalSessions=t.totalCount||0,g.weeklyStressLevel=t.mostCommonStressLevel||"Low",g.avgMood=t.mostCommonEmotion||"neutral"}catch(e){throw console.error("Error loading dashboard summary:",e),e}}async function te(e=10){try{const t=await H(`/api/dashboard/recent?limit=${e}`,"GET");g.recentPredictions=t.map(o=>({date:o.created_at,emotion:o.emotion,stress_level:o.stress_level,stress_percent:o.stress_percent,text:o.text,feedback:o.feedback,history_id:o.history_id})),g.recentActivity=t.slice(0,5).map(o=>({date:o.created_at,text:o.text,emotion:o.emotion}))}catch(t){throw console.error("Error loading recent history:",t),t}}async function oe(){try{const e=[];if(g.recentPredictions.length>0&&g.recentPredictions[0].feedback){const t=g.recentPredictions[0].feedback,o=t.indexOf("Why you're getting this result:"),r=t.indexOf("Suggestions:");let n="",s="";o!==-1&&r!==-1&&(n=t.substring(o+31,r).trim(),s=t.substring(r+12).trim(),n&&e.push(`${n}`),s&&e.push(`${s}`))}g.tips=e,g.tips.length===0&&(g.tips=["• Take regular breaks throughout the day","• Practice deep breathing exercises","• Maintain a consistent sleep schedule","• Engage in physical activities","• Try meditation or mindfulness exercises"])}catch(e){console.error("Error loading stress tips:",e),g.tips=["• Take regular breaks throughout the day","• Practice deep breathing exercises","• Maintain a consistent sleep schedule","• Engage in physical activities"]}}function ne(){const e=document.getElementById("stress-percentage");e&&(e.textContent=`${g.averageStress}%`,g.averageStress>=70?e.className="text-4xl sm:text-6xl font-bold text-red-600 mb-3 sm:mb-4":g.averageStress>=40?e.className="text-4xl sm:text-6xl font-bold text-yellow-600 mb-3 sm:mb-4":e.className="text-4xl sm:text-6xl font-bold text-green-600 mb-3 sm:mb-4")}function ze(){const e=document.getElementById("latest-emotion-emoji"),t=document.getElementById("latest-emotion-text");if(!e||!t)return;const o=g.latestEmotion.toLowerCase();e.textContent=j[o]||"😐",t.textContent=o.charAt(0).toUpperCase()+o.slice(1)}function re(){const e=document.getElementById("total-predictions");e&&(e.textContent=g.totalSessions);const t=document.getElementById("week-predictions");t&&(t.textContent=g.weeklyStressLevel);const o=document.getElementById("avg-mood");if(o){const r=g.avgMood.charAt(0).toUpperCase()+g.avgMood.slice(1);o.textContent=r}}function se(){const e=document.getElementById("emotion-chart");if(!e||!window.Chart)return;b.emotionChart&&b.emotionChart.destroy();const t=e.getContext("2d"),o=["depressed","panicked","anxious","overwhelmed","lonely"],r=o.map(l=>g.emotionCounts[l.charAt(0).toUpperCase()+l.slice(1)]||0),n=r.reduce((l,a)=>l+a,0),s=document.getElementById("emotion-chart-total");s&&(s.textContent=n),o.forEach(l=>{const a=document.getElementById(`${l}-count`);a&&(a.textContent=g.emotionCounts[l.charAt(0).toUpperCase()+l.slice(1)]||0)});const i=["#5e4fa2","#9e7bb5","#d4a5e3","#e0b0e4","#f1d4e0"],d=o.map((l,a)=>({name:l,count:r[a]}));d.sort((l,a)=>a.count-l.count);const c=d.map((l,a)=>i[a]);n>0?b.emotionChart=new Chart(t,{type:"doughnut",data:{labels:o.map(l=>l.charAt(0).toUpperCase()+l.slice(1)),datasets:[{data:r,backgroundColor:c,borderWidth:0}]},options:{responsive:!0,maintainAspectRatio:!1,cutout:"70%",plugins:{legend:{display:!1}}}}):(t.clearRect(0,0,e.width,e.height),t.fillStyle="#6b7280",t.font="14px sans-serif",t.textAlign="center",t.fillText("No data available",e.width/2,e.height/2))}function ie(){const e=document.getElementById("stress-chart");if(!e||!window.Chart)return;b.stressChart&&b.stressChart.destroy();const t=e.getContext("2d");if(g.stressHistory.length===0){t.clearRect(0,0,e.width,e.height),t.fillStyle="#6b7280",t.font="14px sans-serif",t.textAlign="center",t.fillText("No stress data available",e.width/2,e.height/2);return}const o=g.stressHistory.map(n=>{let s;return typeof n.date=="string"?s=new Date(n.date):typeof n.date=="number"?s=new Date(n.date*1e3):s=n.date,s.toLocaleDateString("en-US",{month:"short",day:"numeric"})}),r=g.stressHistory.map(n=>n.value||n.stress_percent||0);b.stressChart=new Chart(t,{type:"line",data:{labels:o,datasets:[{label:"Stress Level (%)",data:r,borderColor:"#ef4444",backgroundColor:"rgba(239, 68, 68, 0.1)",tension:.4,fill:!0,pointBackgroundColor:r.map(n=>n>=70?"#dc2626":n>=40?"#f59e0b":"#10b981"),pointBorderColor:"#ffffff",pointBorderWidth:2,pointRadius:4}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1}},scales:{y:{beginAtZero:!0,max:100,ticks:{callback:function(n){return n+"%"}}},x:{grid:{display:!1}}}}})}function ae(){const e=document.getElementById("predictions-table");if(!e)return;e.innerHTML="";const t=g.recentPredictions.slice(0,5);if(t.length===0){e.innerHTML=`
      <tr>
        <td colspan="5" class="px-6 py-8 text-center text-gray-500">
          No predictions found
        </td>
      </tr>
    `;return}t.forEach(o=>{var c;const r=document.createElement("tr");r.className="border-b hover:bg-gray-50";const n=o.stress_percent>=70?"text-red-600":o.stress_percent>=40?"text-yellow-600":"text-green-600";let s="No suggestion available";if(o.feedback){const l=o.feedback.toLowerCase().indexOf("suggestion");l!==-1&&(s=o.feedback.substring(l).split(`
`)[0].replace(/suggestion[s]?[:\-]\s*/i,"").trim(),s.length>50&&(s=s.substring(0,50)+"..."))}let i=o.text||"No text available";i.length>60&&(i=i.substring(0,60)+"...");let d;try{d=new Date(o.date).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"})}catch{d="Invalid date"}r.innerHTML=`
      <td class="px-6 py-4 text-sm text-gray-900">
        ${d}
      </td>
      <td class="px-6 py-4 text-sm">
        <span class="inline-flex items-center">
          <span class="mr-2">${j[(c=o.emotion)==null?void 0:c.toLowerCase()]||"😐"}</span>
          ${o.emotion?o.emotion.charAt(0).toUpperCase()+o.emotion.slice(1):"Unknown"}
        </span>
      </td>
      <td class="px-6 py-4 text-sm text-gray-500" title="${o.text}">
        ${i}
      </td>
      <td class="px-6 py-4 text-sm font-medium ${n}">
        ${o.stress_level||"N/A"} (${o.stress_percent||0}%)
      </td>
      <td class="px-6 py-4 text-sm text-gray-500" title="${s}">
        ${s.length>40?s.substring(0,40)+"...":s}
      </td>
    `,e.appendChild(r)})}function le(){const e=document.getElementById("stress-tips");e&&(e.innerHTML="",g.tips.forEach(t=>{const o=document.createElement("li");o.className="flex items-start",o.innerHTML=`
      <span class="flex-shrink-0 w-2 h-2 bg-purple-500 rounded-full mt-2 mr-3"></span>
      <span class="text-sm text-gray-700">${t}</span>
    `,e.appendChild(o)}))}function qe(){const e=document.getElementById("recent-activity");if(e){if(e.innerHTML="",g.recentActivity.length===0){e.innerHTML='<div class="text-sm text-gray-500 text-center py-4">No recent activity</div>';return}g.recentActivity.forEach(t=>{var s;const o=document.createElement("div");o.className="flex items-start space-x-3 p-3 bg-gray-50 rounded-lg mb-2";let r=t.text||"No text available";r.length>80&&(r=r.substring(0,80)+"...");let n;try{n=new Date(t.date).toLocaleDateString("en-US",{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}catch{n="Invalid date"}o.innerHTML=`
      <span class="text-lg">${j[(s=t.emotion)==null?void 0:s.toLowerCase()]||"😐"}</span>
      <div class="flex-1 min-w-0">
        <p class="text-sm text-gray-900">${r}</p>
        <p class="text-xs text-gray-500">${n}</p>
      </div>
    `,e.appendChild(o)})}}function We(){const e=document.getElementById("time-filter");e&&e.addEventListener("change",async function(r){await J()});const t=document.getElementById("chart-filter");t&&t.addEventListener("change",async function(r){await J()});const o=document.getElementById("refresh-dashboard");o&&o.addEventListener("click",async()=>{await X()})}function Je(){const e=document.getElementById("time-filter");return e?parseInt(e.value):30}async function J(){try{ce(),await Promise.all([ee(),te()]),await oe(),ne(),re(),ie(),se(),ae(),le(),M()}catch(e){console.error("Error refreshing dashboard:",e),M(),V("Failed to refresh dashboard data")}}function ce(){document.querySelectorAll(".loading-placeholder").forEach(t=>t.classList.remove("hidden"))}function M(){document.querySelectorAll(".loading-placeholder").forEach(t=>t.classList.add("hidden"))}function V(e){const t=document.createElement("div");t.className="fixed top-4 right-4 bg-red-500 text-white px-4 py-2 rounded shadow-lg z-50",t.textContent=e,document.body.appendChild(t),setTimeout(()=>{document.body.contains(t)&&document.body.removeChild(t)},5e3)}function Ye(){[{selector:'a[href="#home"]',view:"home"},{selector:'a[href="#curhat"]',view:"curhat"},{selector:'a[href="#feedback"]',view:"feedback"},{selector:'a[href="#dashboard"]',view:"dashboard"},{selector:'a[href="#logout"]',view:"logout"}].forEach(({selector:t,view:o})=>{const r=document.querySelector(t);r&&r.addEventListener("click",n=>{n.preventDefault(),o==="logout"?Ze():de(o)})})}function Ze(){Object.values(b).forEach(e=>{e&&typeof e.destroy=="function"&&e.destroy()}),b={},localStorage.clear(),sessionStorage.removeItem("isLoggedIn"),console.log("User logged out, session cleared"),de("home")}function de(e){switch(e!=="dashboard"&&(Object.values(b).forEach(t=>{t&&typeof t.destroy=="function"&&t.destroy()}),b={}),e){case"home":E(()=>Promise.resolve().then(()=>Ee),void 0,import.meta.url).then(t=>t.renderHome());break;case"curhat":E(()=>Promise.resolve().then(()=>Me),void 0,import.meta.url).then(t=>t.renderCurhat());break;case"feedback":E(()=>Promise.resolve().then(()=>Ve),void 0,import.meta.url).then(t=>t.renderFeedback());break;case"dashboard":O();break;default:console.warn("Unknown view:",e);break}}const ue=Object.freeze(Object.defineProperty({__proto__:null,renderDashboard:O},Symbol.toStringTag,{value:"Module"}));function Ge(){return fetch("views/forgetPasswordView.html").then(e=>{if(!e.ok)throw new Error("Failed to load forget password view");return e.text()}).then(e=>{document.getElementById("app").innerHTML=e,Ke()}).catch(e=>{console.error("Error loading forget password view:",e),y("Failed to load page")})}function Ke(){const e=document.getElementById("send-code-btn"),t=document.getElementById("verify-code-btn"),o=document.getElementById("reset-password-btn"),r=document.getElementById("back-to-login");e?e.addEventListener("click",n=>Qe(n,e)):console.error("sendCodeBtn not found in DOM"),t?t.addEventListener("click",n=>Xe(n,t)):console.error("verifyCodeBtn not found in DOM"),o?o.addEventListener("click",n=>et(n,o)):console.error("resetPasswordBtn not found in DOM"),r?r.addEventListener("click",n=>{n.preventDefault(),window.loadView("login")}):console.error("backToLoginLink not found in DOM")}async function Qe(e,t){e.preventDefault();const o=document.getElementById("loginEmail"),r=o==null?void 0:o.value.trim();if(N(),console.log("handleSendCode started with email:",r),!r){y("email-error","Email is required"),alert("Error: Email is required");return}if(!/\S+@\S+\.\S+/.test(r)){y("email-error","Invalid email format"),alert("Error: Invalid email format");return}if(!t){console.error("Button reference is undefined in handleSendCode"),y("email-error","Internal error: Button not found"),alert("Error: Internal error - Button not found");return}B(!0,t),console.log("Sending request to /api/forgot-password/request with email:",r);try{const n=await x("/api/forgot-password/request",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:r})});if(console.log("API response received:",n),!n.message)throw new Error("Invalid response from server");ge("code-stage"),R("Verification code sent to your email"),alert("Success: Verification code sent to your email!")}catch(n){console.error("API call failed:",n),y("email-error",n.message||"Failed to send code"),alert(`Error: Failed to send code - ${n.message||"Unknown error"}`)}finally{B(!1,t),console.log("handleSendCode completed")}}async function Xe(e,t){var s;e.preventDefault();const o=(s=document.getElementById("loginEmail"))==null?void 0:s.value.trim(),r=document.getElementById("verificationCode"),n=r==null?void 0:r.value.trim();if(N(),!n){y("code-error","Code is required");return}if(!/^\d{6}$/.test(n)){y("code-error","Code must be a 6-digit number");return}if(!t){console.error("Button reference is undefined in handleVerifyCode"),y("code-error","Internal error: Button not found");return}B(!0,t);try{if(!(await x("/api/forgot-password/verify",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:o,code:n})})).message)throw new Error("Invalid response from server");ge("password-stage"),R("Code verified successfully")}catch(i){y("code-error",i.message||"Invalid or expired code")}finally{B(!1,t)}}async function et(e,t){var c;e.preventDefault();const o=(c=document.getElementById("loginEmail"))==null?void 0:c.value.trim(),r=document.getElementById("newPassword"),n=document.getElementById("confirmPassword"),s=r==null?void 0:r.value,i=n==null?void 0:n.value;if(N(),!s||!i){s||y("new-password-error","New password is required"),i||y("confirm-password-error","Confirm password is required");return}const d=tt(s);if(!d.isValid){y("new-password-error",d.message);return}if(s!==i){y("confirm-password-error","Passwords do not match");return}if(!t){console.error("Button reference is undefined in handleResetPassword"),y("new-password-error","Internal error: Button not found");return}B(!0,t);try{if(!(await x("/api/forgot-password/reset",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:o,newPassword:s})})).message)throw new Error("Invalid response from server");R("Password reset successfully! Redirecting to login..."),setTimeout(()=>window.loadView("login"),2e3)}catch(l){y("new-password-error",l.message||"Failed to reset password")}finally{B(!1,t)}}function tt(e){const o=/[a-zA-Z]/.test(e),r=/\d/.test(e),n=/[!@#$%^&*(),.?":{}|<>]/.test(e);return e.length<8||!(o&&r&&n)?{isValid:!1,message:"Password must be at least 8 characters long and include a mix of letters, numbers, and symbols."}:{isValid:!0,message:""}}function ge(e){["email-stage","code-stage","password-stage"].forEach(r=>{const n=document.getElementById(r);n&&n.classList.add("hidden")});const o=document.getElementById(e);o&&o.classList.remove("hidden")}function y(e,t){const o=document.getElementById(e);o&&(o.textContent=t,o.classList.remove("hidden"))}function N(){document.querySelectorAll("[id$='-error']").forEach(t=>{t.textContent="",t.classList.add("hidden")})}function R(e){N();const t=document.getElementById("email-error");t&&(t.textContent=e,t.classList.remove("hidden","text-red-600"),t.classList.add("text-green-600"))}function B(e,t){e?(t.disabled=!0,t.textContent="Processing..."):(t.disabled=!1,t.textContent=t.id==="send-code-btn"?"Send Code":t.id==="verify-code-btn"?"Verify Code":"Reset Password")}function ot(){fetch("views/articlesView.html").then(e=>{if(!e.ok)throw new Error("Failed to load articlesView.html");return e.text()}).then(e=>{document.getElementById("app").innerHTML=e,console.log("Articles view loaded, initializing..."),it(),nt()}).catch(e=>{console.error("Error loading articles view:",e),document.getElementById("app").innerHTML=`
        <div class="p-4 text-center">
          <h2 class="text-xl font-bold text-red-600">Error Loading Articles</h2>
          <p class="text-gray-600">Failed to load the articles view: ${e.message}</p>
        </div>
      `})}window.allArticles=[];window.filteredArticles=[];window.currentPage=1;window.articlesPerPage=12;function nt(){const e=document.querySelector(".articles-section");if(e&&!document.getElementById("search-input")){const r=`
      <div class="mb-6 max-w-md">
        <div class="relative">
          <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
            <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
            </svg>
          </div>
          <input type="text" id="search-input" placeholder="Search articles..." 
                 class="block w-full pl-10 pr-10 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-violet-500 focus:border-violet-500 outline-none transition-all duration-200">
          <button id="clear-search" class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600 hidden">
            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
        <div id="search-info" class="mt-2 text-sm text-gray-600 hidden">
          <span id="results-count"></span> articles found
        </div>
      </div>
    `,n=e.querySelector("h2");n&&n.insertAdjacentHTML("afterend",r)}const t=document.getElementById("search-input"),o=document.getElementById("clear-search");t&&t.addEventListener("input",rt),o&&o.addEventListener("click",st)}function rt(e){const t=e.target.value.toLowerCase().trim(),o=document.getElementById("clear-search"),r=document.getElementById("search-info"),n=document.getElementById("results-count");t&&o?o.classList.remove("hidden"):o&&o.classList.add("hidden"),t&&r?r.classList.remove("hidden"):r&&r.classList.add("hidden"),t===""?window.filteredArticles=window.allArticles:window.filteredArticles=window.allArticles.filter(s=>s.title&&s.title.toLowerCase().includes(t)||s.article_intro&&s.article_intro.toLowerCase().includes(t)),n&&(n.textContent=window.filteredArticles.length),window.currentPage=1,S(window.filteredArticles)}function st(){const e=document.getElementById("search-input"),t=document.getElementById("clear-search"),o=document.getElementById("search-info");e&&(e.value=""),t&&t.classList.add("hidden"),o&&o.classList.add("hidden"),window.filteredArticles=window.allArticles,window.currentPage=1,S(window.filteredArticles)}async function it(){const e=document.getElementById("articles-container");try{e&&(e.innerHTML=`
        <div class="flex justify-center items-center py-8">
          <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-violet-700"></div>
          <span class="ml-2 text-gray-600">Loading articles...</span>
        </div>
      `),console.log("Fetching articles...");const t=await at();if(console.log("Received articles:",{count:t.length,sample:t.slice(0,2)}),!t||t.length===0){console.log("No articles received"),e&&(e.innerHTML=`
          <div class="text-center py-8">
            <svg class="mx-auto h-12 w-12 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6-4h6"></path>
            </svg>
            <h3 class="text-lg font-semibold text-gray-700">No Articles Available</h3>
            <p class="text-gray-500">Check back later for new content!</p>
          </div>
        `);return}window.allArticles=t,window.filteredArticles=t,window.currentPage=1,console.log("Rendering article cards..."),S(t)}catch(t){console.error("Error initializing articles:",t),e&&(e.innerHTML=`
        <div class="text-center py-8">
          <div class="bg-red-50 border border-red-200 rounded-lg p-6 max-w-md mx-auto">
            <svg class="mx-auto h-12 w-12 text-red-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <h3 class="text-lg font-semibold text-red-600 mb-2">Failed to Load Articles</h3>
            <p class="text-gray-600 mb-4">${t.message}</p>
            <button onclick="location.reload()" class="px-4 py-2 bg-violet-700 text-white rounded-lg hover:bg-violet-800 transition-colors duration-200">
              Try Again
            </button>
          </div>
        </div>
      `)}}async function at(){try{console.log("Making API call to /api/articles...");const e=await x("/api/articles");return console.log("API call successful:",{isArray:Array.isArray(e),length:(e==null?void 0:e.length)||0}),Array.isArray(e)?e:[]}catch(e){throw console.error("Error fetching articles:",e),e.message.includes("fetch")?new Error("Unable to connect to server. Please check if the backend is running."):e.message.includes("JSON")?new Error("Server returned invalid data format."):new Error(`Failed to load articles: ${e.message}`)}}function S(e){const t=document.getElementById("articles-container");if(!t){console.error("Articles container not found in DOM");return}try{if(t.className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 justify-items-start",e.length===0){t.innerHTML=`
        <div class="col-span-full text-center py-12">
          <svg class="mx-auto h-12 w-12 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 12h6m-6-4h6"></path>
          </svg>
          <h3 class="text-lg font-medium text-gray-700 mb-2">No articles found</h3>
          <p class="text-gray-500">Try searching with different keywords</p>
        </div>
      `,document.getElementById("pagination").innerHTML="";return}t.innerHTML="";const o=(window.currentPage-1)*window.articlesPerPage,r=o+window.articlesPerPage,n=e.slice(o,r);console.log(`Rendering ${n.length} articles (page ${window.currentPage})`),n.forEach((s,i)=>{try{const d=document.createElement("div");d.className="w-full max-w-sm bg-white rounded-xl shadow-md overflow-hidden hover:shadow-xl transition-all duration-300 hover:-translate-y-1 border border-gray-100";const c=s.img&&s.img.trim()?s.img:"https://images.unsplash.com/photo-1586953208448-b95a79798f07?w=300&h=200&fit=crop",l=s.article_link&&s.article_link.trim()?s.article_link:"#",a=s.title?s.title.length>60?s.title.substring(0,60)+"...":s.title:"Untitled Article",u=s.article_intro?s.article_intro.length>120?s.article_intro.substring(0,120)+"...":s.article_intro:"No description available";d.innerHTML=`
          <div class="relative overflow-hidden">
            <img src="${c}" alt="${a}" 
                 class="w-full h-48 object-cover transition-transform duration-300 hover:scale-105" 
                 onerror="this.src='https://images.unsplash.com/photo-1586953208448-b95a79798f07?w=300&h=200&fit=crop'">
          </div>
          <div class="p-5">
            <h3 class="text-lg font-bold text-gray-800 mb-3 leading-tight">${a}</h3>
            <p class="text-sm text-gray-600 mb-4 leading-relaxed">${u}</p>
            ${l!=="#"?`<a href="${l}" 
                 class="inline-flex items-center text-sm font-medium text-violet-600 hover:text-violet-800 transition-colors duration-200" 
                 target="_blank" rel="noopener">
                  Read More 
                  <svg class="ml-1 w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                  </svg>
               </a>`:'<span class="text-sm text-gray-400">Link not available</span>'}
          </div>
        `,t.appendChild(d)}catch(d){console.error(`Error rendering article card ${i}:`,d,s)}}),lt(e)}catch(o){console.error("Error in renderArticleCards:",o),t.innerHTML=`
      <div class="col-span-full text-center py-8">
        <p class="text-red-600">Error displaying articles</p>
      </div>
    `}}function lt(e){const t=Math.ceil(e.length/window.articlesPerPage),o=document.getElementById("pagination");if(!o){console.error("Pagination element not found");return}if(t<=1){o.innerHTML="",o.style.paddingBottom="3rem";return}if(o.innerHTML="",o.className="flex flex-wrap justify-center items-center gap-2 mt-8 pb-12",window.currentPage>1){const c=document.createElement("button");c.innerHTML=`
      <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
      </svg>
      <span class="hidden sm:inline">Previous</span>
    `,c.className="inline-flex items-center px-3 py-2 text-sm bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors duration-200",c.addEventListener("click",()=>{window.currentPage--,S(window.filteredArticles)}),o.appendChild(c)}const n=window.innerWidth<640?3:5,s=Math.max(1,window.currentPage-Math.floor(n/2)),i=Math.min(t,s+n-1);if(s>1){const c=F(1);if(o.appendChild(c),s>2){const l=document.createElement("span");l.textContent="...",l.className="px-2 text-gray-500",o.appendChild(l)}}for(let c=s;c<=i;c++){const l=F(c,c===window.currentPage);o.appendChild(l)}if(i<t){if(i<t-1){const l=document.createElement("span");l.textContent="...",l.className="px-2 text-gray-500",o.appendChild(l)}const c=F(t);o.appendChild(c)}if(window.currentPage<t){const c=document.createElement("button");c.innerHTML=`
      <span class="hidden sm:inline">Next</span>
      <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
      </svg>
    `,c.className="inline-flex items-center px-3 py-2 text-sm bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors duration-200",c.addEventListener("click",()=>{window.currentPage++,S(window.filteredArticles)}),o.appendChild(c)}const d=document.createElement("div");d.textContent=`Page ${window.currentPage} of ${t}`,d.className="text-sm text-gray-500 mt-2 w-full text-center sm:w-auto sm:mt-0 sm:ml-4",o.appendChild(d)}function F(e,t=!1){const o=document.createElement("button");return o.textContent=e,o.className=`px-3 py-2 text-sm rounded-lg transition-all duration-200 font-medium ${t?"bg-violet-600 text-white shadow-md":"bg-white text-gray-700 hover:bg-violet-50 hover:text-violet-600 border border-gray-200"}`,o.addEventListener("click",()=>{window.currentPage=e,S(window.filteredArticles)}),o}console.log("historyDetailPresenter.js loaded");async function ct(e){if(console.log("renderHistoryDetail called with historyId:",e),!e||e==="undefined"||e==="null"){console.error("Invalid historyId:",e),$("Invalid history ID provided");return}try{fetch("/views/historydetailView.html").then(t=>{if(!t.ok)throw new Error("Failed to load historydetailView.html");return t.text()}).then(t=>{document.getElementById("app").innerHTML=t,dt(),ut(e)}).catch(t=>{console.error("Error loading history detail view:",t),$(`Failed to load the history detail view: ${t.message}`)})}catch(t){console.error("Error rendering history detail:",t),$(`Error rendering history detail: ${t.message}`)}}function dt(){[{selector:'a[href="#dashboard"]',view:"dashboard"},{selector:'a[href="#history"]',view:"history"},{selector:'a[href="#logout"]',view:"logout"}].forEach(({selector:t,view:o})=>{const r=document.querySelector(t);r&&r.addEventListener("click",n=>{n.preventDefault(),o==="logout"?me():fe(o)})})}function me(){localStorage.clear(),location.reload()}function fe(e){switch(e){case"dashboard":E(()=>Promise.resolve().then(()=>ue),void 0,import.meta.url).then(t=>t.renderDashboard());break;case"history":E(()=>Promise.resolve().then(()=>we),void 0,import.meta.url).then(t=>t.renderHistory());break;case"logout":me();break;default:console.warn(`View '${e}' not recognized`)}}async function ut(e){try{console.log("Loading history detail for ID:",e);const t=await H(`/api/history/${e}`);t?gt(t):mt()}catch(t){console.error("Error loading history detail:",t),$(`Failed to load history detail: ${t.message}`)}}function gt(e){console.log("Displaying history detail:",e);const t=document.getElementById("percentage"),o=document.getElementById("stress-title"),r=document.getElementById("emotion-badge"),n=document.getElementById("user-input"),s=document.getElementById("analysis-text"),i=document.querySelectorAll(".video-embed"),d=e.stress_percent.toFixed(1);if(t&&(t.textContent=`${d}%`),t&&t.parentElement){const l=t.parentElement;let a;d>66?a="#dc2626":d>33?a="#eab308":a="#16a34a";const u=112,m=8,p=(u-m)/2,h=2*Math.PI*p,w=h,v=h-d/100*h;l.innerHTML=`
      <div class="relative w-28 h-28 flex items-center justify-center">
        <svg class="absolute inset-0 w-full h-full transform -rotate-90" viewBox="0 0 ${u} ${u}">
          <!-- Background circle -->
          <circle
            cx="${u/2}"
            cy="${u/2}"
            r="${p}"
            stroke="#e5e7eb"
            stroke-width="${m}"
            fill="transparent"
          />
          <!-- Progress circle -->
          <circle
            cx="${u/2}"
            cy="${u/2}"
            r="${p}"
            stroke="${a}"
            stroke-width="${m}"
            fill="transparent"
            stroke-dasharray="${w}"
            stroke-dashoffset="${v}"
            stroke-linecap="round"
            class="transition-all duration-1000 ease-out"
          />
        </svg>
        <div class="relative z-10 text-center">
          <div class="text-xl font-bold text-gray-800">${d}%</div>
        </div>
      </div>
    `}if(o){let l="Unknown";if(e.stress_level)switch(e.stress_level.toLowerCase()){case"low":l="Low Stress";break;case"medium":l="Medium Stress";break;case"high":l="High Stress";break;default:l=e.stress_level.charAt(0).toUpperCase()+e.stress_level.slice(1)}o.textContent=l}if(r&&(r.textContent=`Emotion: ${e.emotion||"Unknown"}`,r.className="inline-block bg-violet-800 text-white rounded-full px-3 py-1 text-sm mb-3"),n&&(n.textContent=e.text||"No input provided."),s&&e.feedback){const l=e.feedback.split("Suggestions:");let a=l[0].replace(/^-\s*|\s*-$/g,"").trim();const u=l[1]?l[1].trim():"",m="Why you're getting this result:";a.startsWith(m)&&(a=a.slice(m.length).trim()),s.innerHTML=`
      <strong>Why you're getting this result:</strong> ${a}
      ${u?`<br><br><strong>Suggestions:</strong> ${u}`:""}
    `}else s&&(s.textContent="No feedback provided.");let c=[];if(e.video_link)try{c=JSON.parse(e.video_link),console.log("Parsed video links:",c)}catch(l){console.error("Error parsing video links:",l),c=[]}i.forEach((l,a)=>{const u=c[a];u&&u.trim()!==""?(console.log(`Setting video ${a}:`,u),l.innerHTML=`
        <iframe 
          width="100%" 
          height="100%" 
          src="${u}" 
          frameborder="0" 
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
          allowfullscreen
          class="w-full h-full rounded-lg">
        </iframe>`):(console.log(`No video available for embed ${a}`),l.innerHTML=`
        <div class="flex items-center justify-center text-gray-600 h-full">
          <div class="text-center">
            <svg class="w-8 h-8 mx-auto mb-2 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
            </svg>
            <p class="text-sm">No video available</p>
          </div>
        </div>`)})}function mt(){const e=document.getElementById("app");e&&(e.innerHTML=`
      <div class="max-w-6xl mx-auto px-4 py-8 text-center">
        <div class="text-gray-400 mb-4">
          <svg class="w-16 h-16 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
          </svg>
        </div>
        <p class="text-gray-500 text-lg">No history detail available</p>
        <button onclick="loadView('history')" class="mt-4 px-4 py-2 bg-violet-600 text-white rounded-lg hover:bg-violet-700 transition-colors">
          Back to History
        </button>
      </div>
    `)}function $(e){const t=document.getElementById("app");t&&(t.innerHTML=`
      <div class="max-w-6xl mx-auto px-4 py-8 text-center">
        <div class="text-red-400 mb-4">
          <svg class="w-16 h-16 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 15.5c-.77.833.192 2.5 1.732 2.5z"></path>
          </svg>
        </div>
        <p class="text-red-500 text-lg">${e}</p>
        <button onclick="loadView('history')" class="mt-4 px-4 py-2 bg-violet-600 text-white rounded-lg hover:bg-violet-700 transition-colors">
          Back to History
        </button>
      </div>
    `)}window.loadView=fe;function he(){fetch("views/historyView.html").then(e=>{if(!e.ok)throw new Error("Failed to load historyView.html");return e.text()}).then(e=>{document.getElementById("app").innerHTML=e,console.log("History view loaded, initializing..."),U()}).catch(e=>{console.error("Error loading history view:",e),document.getElementById("app").innerHTML=`
        <div class="p-4 text-center">
          <h2 class="text-xl font-bold text-red-600">Error Loading History</h2>
          <p class="text-gray-600">Failed to load the history view: ${e.message}</p>
        </div>
      `})}class pe{constructor(t){this.view=t,this.allHistory=[],this.filteredHistory={}}async loadHistory(){try{this.view.showLoading();const t=await H("/api/history");this.allHistory=t;const o=this.groupFeedbacksByPeriod(t);this.filteredHistory=o,this.view.renderHistory(o),this.setupFilterListener()}catch(t){console.error("Failed to load feedback history:",t),this.view.renderError("Failed to load history data. Please try again.")}}setupFilterListener(){const t=document.getElementById("filterDropdown");t&&t.addEventListener("change",o=>{this.filterHistory(o.target.value)})}groupFeedbacksByPeriod(t){const o=new Date().toLocaleString("en-US",{timeZone:"Asia/Jakarta"}),r=new Date(o);new Date(o).setDate(r.getDate()-1);const s=new Date(o);s.setDate(r.getDate()-r.getDay()+1),s.setHours(0,0,0,0);const i=r.getFullYear(),d=r.getMonth(),c={today:[],thisWeek:[],lastMonth:[],earlierThisYear:[],lastYear:[]};return t.forEach(l=>{let a;if(typeof l.created_at=="string"&&l.created_at.includes(" ")?(a=new Date(l.created_at+" UTC"),a=new Date(a.toLocaleString("en-US",{timeZone:"Asia/Jakarta"}))):a=new Date(new Date(l.created_at).toLocaleString("en-US",{timeZone:"Asia/Jakarta"})),a.getFullYear()===r.getFullYear()&&a.getMonth()===r.getMonth()&&a.getDate()===r.getDate())c.today.push(l);else if(a>=s&&a<=r)c.thisWeek.push(l);else if(a.getFullYear()===i&&a.getMonth()===d-1)c.lastMonth.push(l);else if(a.getFullYear()===i)c.earlierThisYear.push(l);else if(a.getFullYear()===i-1)c.lastYear.push(l);else{const u=a.getFullYear().toString();c[u]||(c[u]=[]),c[u].push(l)}}),c}filterHistory(t){if(console.log("Filtering by:",t),t==="all")this.view.renderHistoryContent(this.filteredHistory);else{const r={};this.filteredHistory[t]&&this.filteredHistory[t].length>0&&(r[t]=this.filteredHistory[t]),this.view.renderHistoryContent(r)}this.setupFilterListener();const o=document.getElementById("filterDropdown");o&&(o.value=t)}getHistoryItem(t){return this.allHistory.find(o=>o.history_id===t)}searchHistory(t){const o=this.allHistory.filter(n=>n.text&&n.text.toLowerCase().includes(t.toLowerCase())),r=this.groupFeedbacksByPeriod(o);this.view.renderHistoryContent(r)}showDetail(t){console.log("showDetail called with historyId:",t),ct(t)}}class ye{constructor(){this.container=null,this.presenter=null}showLoading(){const t=document.getElementById("app");t.innerHTML=`
      <main class="max-w-6xl mx-auto px-4 py-8 sm:px-6 lg:px-10">
        <div class="flex justify-center items-center py-12">
          <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-violet-700"></div>
          <span class="ml-3 text-gray-600">Loading your history...</span>
        </div>
      </main>
    `}renderHistory(t){const o=document.getElementById("app");o.innerHTML=`
      <main class="max-w-6xl mx-auto px-4 py-8 sm:px-6 lg:px-10 xl:py-20">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-8">
          <h1 class="text-2xl font-bold text-gray-600">Your History</h1>
          <div class="w-full sm:w-64 lg:w-48">
            <select id="filterDropdown" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-violet-700 focus:border-transparent bg-white text-gray-500 text-sm">
              <option value="all">All Time</option>
              <option value="today">Today</option>
              <option value="thisWeek">This Week</option>
              <option value="lastMonth">Last Month</option>
              <option value="earlierThisYear">Earlier This Year</option>
              <option value="lastYear">Last Year</option>
            </select>
          </div>
        </div>
        <div id="historyContainer"></div>
      </main>
    `,this.renderHistoryContent(t)}renderHistoryContent(t){const o=document.getElementById("historyContainer");if(!o)return;this.container=o,o.innerHTML="";const r=[{key:"today",label:"Today"},{key:"thisWeek",label:"This Week"},{key:"lastMonth",label:"Last Month"},{key:"earlierThisYear",label:"Earlier This Year"},{key:"lastYear",label:"Last Year"},...Object.keys(t).filter(s=>!["today","thisWeek","lastMonth","earlierThisYear","lastYear"].includes(s)).sort((s,i)=>i-s).map(s=>({key:s,label:s}))];let n=!1;r.forEach((s,i)=>{const d=t[s.key];if(d&&d.length>0){n=!0;const c=`history-${s.key.toLowerCase().replace(/\s/g,"-")}`,l=`
          <div class="${i>0?"mt-12":""}">
            <h2 class="text-2xl font-semibold text-gray-600 mb-6">${s.label}</h2>
            <div id="${c}" class="grid gap-4 md:gap-6"></div>
          </div>
        `;o.insertAdjacentHTML("beforeend",l),this.renderSection(c,d)}}),n||(o.innerHTML=`
        <div class="text-center py-12">
          <div class="text-gray-400 mb-4">
            <svg class="w-16 h-16 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
          </div>
          <p class="text-gray-500 text-lg">No history entries found for this period.</p>
          <p class="text-gray-400 text-sm mt-2">Try selecting a different time period or check back later.</p>
        </div>
      `)}renderSection(t,o){const r=document.getElementById(t);if(r){if(r.innerHTML="",o.length===0){r.innerHTML='<p class="text-gray-500 italic">Nothing to show here.</p>';return}o.forEach(n=>{const s=document.createElement("div");s.className="bg-white shadow-md rounded-xl p-6 hover:shadow-lg transition-all duration-200 cursor-pointer border border-gray-100",s.dataset.historyId=n.history_id;const i=Math.round((n.stress_percent||0)*100)/100,d=n.stress_level||"unknown",c=n.emotion||"neutral",l=n.text||"No description",a=new Date(new Date(n.created_at).toLocaleString("en-US",{timeZone:"Asia/Jakarta"}));s.innerHTML=`
        <div class="flex items-center justify-between">
          <div class="flex items-center space-x-4">
            <div class="flex-shrink-0">
              ${this.createDonutChart(i)}
            </div>
            <div class="flex-1 min-w-0">
              <div class="flex flex-wrap items-center gap-2 mb-2">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${this.getStressLevelClass(d)}">
                  ${this.capitalizeFirst(d)} Stress
                </span>
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${this.getEmotionClass(c)}">
                  ${this.capitalizeFirst(c)}
                </span>
              </div>
              <p class="text-sm text-gray-500 mb-2">${this.formatDate(a)}</p>
              <p class="text-gray-700 text-sm line-clamp-2">${l}</p>
            </div>
          </div>
          <div class="flex-shrink-0 ml-4">
            <svg class="w-6 h-6 text-violet-700 cursor-pointer detail-button" fill="none" stroke="currentColor" viewBox="0 0 24 24" data-history-id="${n.history_id}">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
          </div>
        </div>
      `,r.appendChild(s)}),this.attachDetailButtonListeners(t)}}attachDetailButtonListeners(t){const o=document.getElementById(t);if(!o)return;o.querySelectorAll(".detail-button").forEach(n=>{n.addEventListener("click",s=>{s.stopPropagation();const i=n.dataset.historyId;console.log("Detail button clicked for history ID:",i),this.presenter.showDetail(i)})})}renderError(t){const o=document.getElementById("app");o.innerHTML=`
      <main class="max-w-6xl mx-auto px-4 py-8 sm:px-6 lg:px-10">
        <div class="text-center py-12">
          <div class="text-red-400 mb-4">
            <svg class="w-16 h-16 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 15.5c-.77.833.192 2.5 1.732 2.5z"></path>
            </svg>
          </div>
          <p class="text-red-500 text-lg">${t}</p>
          <button onclick="window.location.reload()" class="mt-4 px-4 py-2 bg-violet-600 text-white rounded-lg hover:bg-violet-700 transition-colors">
            Try Again
          </button>
        </div>
      </main>
    `}createDonutChart(t){const r=2*Math.PI*28,n=r,s=r-t/100*r;let i="#10b981";return t>33&&t<=66?i="#f59e0b":t>66&&(i="#ef4444"),`
      <div class="relative" style="width: 64px; height: 64px;">
        <svg width="64" height="64" class="transform -rotate-90">
          <circle cx="32" cy="32" r="28" fill="none" stroke="#e5e7eb" stroke-width="4" />
          <circle cx="32" cy="32" r="28" fill="none" stroke="${i}" stroke-width="4" stroke-linecap="round" stroke-dasharray="${n}" stroke-dashoffset="${s}" class="transition-all duration-300 ease-in-out" />
        </svg>
        <div class="absolute inset-0 flex items-center justify-center">
          <span class="text-gray-700 font-bold text-xs">${t.toFixed(1)}%</span>
        </div>
      </div>
    `}getStressLevelClass(t){return{Low:"bg-green-100 text-green-800",Medium:"bg-yellow-200 text-yellow-800",High:"bg-red-100 text-red-800"}[t]||"bg-gray-100 text-gray-800"}getEmotionClass(t){return{Overwhelmed:"bg-blue-100 text-blue-800",Lonely:"bg-violet-100 text-violet-800",Depressed:"bg-rose-100 text-rose-800",Panicked:"bg-purple-100 text-purple-800",Anxious:"bg-cyan-100 text-cyan-800"}[t]||"bg-gray-100 text-gray-800"}capitalizeFirst(t){return t?t.charAt(0).toUpperCase()+t.slice(1):""}formatDate(t){const o=new Date(new Date().toLocaleString("en-US",{timeZone:"Asia/Jakarta"})),r=Math.abs(o-t),n=Math.ceil(r/(1e3*60*60*24));return n===1?"Today at "+t.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):n===2?"Yesterday at "+t.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):n<=7?t.toLocaleDateString([],{weekday:"long"})+" at "+t.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):t.toLocaleDateString([],{month:"short",day:"numeric",year:"numeric"})}}const A=new ye;A.presenter=new pe(A);function U(){A.presenter.loadHistory()}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{U()}):U();const we=Object.freeze(Object.defineProperty({__proto__:null,HistoryPresenter:pe,HistoryView:ye,renderHistory:he,view:A},Symbol.toStringTag,{value:"Module"}));let f=null;function ft(){console.log("renderAccount called"),console.log("isLoggedIn:",sessionStorage.getItem("isLoggedIn")),console.log("user:",sessionStorage.getItem("user")),console.log("token:",sessionStorage.getItem("token"));const e=sessionStorage.getItem("isLoggedIn")==="true";if(console.log("isLoggedIn check result:",e),!e){console.log("Not logged in, redirecting to login"),window.loadView("login");return}fetch("views/account.html").then(t=>{if(!t.ok)throw new Error("Failed to load account.html");return t.text()}).then(t=>{console.log("Account HTML loaded successfully"),document.getElementById("app").innerHTML=t;const o=JSON.parse(sessionStorage.getItem("user")||"{}");if(o&&o.name){f=o;const r=document.getElementById("dropdown-username"),n=document.getElementById("dropdown-email"),s=document.getElementById("username-field");r&&(r.textContent=o.name),n&&(n.textContent=o.email),s&&(s.value=o.name),_()}try{ht(),vt(),new URLSearchParams(window.location.search).get("success")==="true"&&(z("Profile updated successfully"),window.history.replaceState({},document.title,window.location.pathname))}catch(r){console.error("Error initializing account page:",r),k("Failed to load account information")}}).catch(t=>{console.error("Error loading account view:",t)})}async function ht(){try{const e=await x("/api/profile",{method:"GET"});if(!e||!e.user)throw new Error("Failed to fetch profile");f=e.user,sessionStorage.setItem("user",JSON.stringify(f)),_()}catch(e){console.error("Error fetching profile:",e),k("Failed to fetch latest profile data. Using cached data."),_()}}function pt(e){const o=/[a-zA-Z]/.test(e),r=/\d/.test(e),n=/[!@#$%^&*(),.?":{}|<>]/.test(e);return e.length<8||!(o&&r&&n)?{isValid:!1,message:"Password must be at least 8 characters long and include a mix of letters, numbers, and symbols."}:{isValid:!0,message:""}}function Y(e){var o;const t="https://via.placeholder.com/150x150/e2e8f0/64748b?text=User";try{if(!(f!=null&&f.img)){e.src=t;return}if(typeof f.img=="string"){if(f.img.startsWith("http")||f.img.startsWith("data:image/")){e.src=f.img;return}if(f.img.startsWith("\\x"))try{const n=((o=f.img.substring(2).match(/.{2}/g))==null?void 0:o.map(s=>String.fromCharCode(parseInt(s,16))).join(""))||"";if(n.startsWith("http")){e.src=n;return}}catch(r){console.error("Error decoding hex string:",r)}}if(f.img&&typeof f.img=="object"&&f.img.data){const r=wt(f.img.data);if(r){e.src=r;return}}e.src=t,e.onerror=()=>{console.warn("Failed to load profile image, using default"),e.src=t,e.onerror=null}}catch(r){console.error("Error displaying profile image:",r),e.src=t}}function _(){const e=document.getElementById("username");e&&(e.textContent=(f==null?void 0:f.name)||"User");const t=document.getElementById("profile-image-preview");t&&Y(t);const o=document.getElementById("profile-image");o&&Y(o);const r=document.getElementById("username-field"),n=document.getElementById("email");r&&(r.value=(f==null?void 0:f.name)||""),n&&(n.value=(f==null?void 0:f.email)||"")}async function yt(e){var d,c,l;e.preventDefault(),Et();const t=document.getElementById("username-field")||document.getElementById("username"),o=t?t.value.trim():"",r=((d=document.getElementById("current-password"))==null?void 0:d.value)||"",n=((c=document.getElementById("new-password"))==null?void 0:c.value)||"",s=((l=document.getElementById("confirm-password"))==null?void 0:l.value)||"",i=document.getElementById("profile-image-input");if(!o){C("username","Username is required");return}if(n||r||s){if(!r){C("current-password","Current password is required to change password");return}if(!n){C("new-password","New password is required");return}const a=pt(n);if(!a.isValid){C("new-password",a.message);return}if(n!==s){C("confirm-password","Passwords do not match");return}}ve();try{const a=sessionStorage.getItem("token"),u=new FormData;u.append("name",o),n&&r&&(u.append("currentPassword",r),u.append("newPassword",n)),i&&i.files.length>0&&u.append("profileImage",i.files[0]);const m=await fetch(`${Z}/api/profile`,{method:"PUT",headers:{Authorization:`Bearer ${a}`},body:u});if(!m.ok){let P=await m.text();throw console.error("Update profile failed:",m.status,P),new Error(`Failed to update profile: ${m.status} - ${P}`)}const p=m.headers.get("content-type");if(!p||!p.includes("application/json")){let P=await m.text();throw console.error("Non-JSON response:",P),new Error("Non-JSON response from server")}f=(await m.json()).user,sessionStorage.setItem("user",JSON.stringify(f)),_();const w=document.getElementById("current-password"),v=document.getElementById("new-password"),L=document.getElementById("confirm-password");w&&(w.value=""),v&&(v.value=""),L&&(L.value=""),z()}catch(a){console.error("Error updating profile:",a),k(a.message||"Failed to update profile")}finally{xe()}}function wt(e){try{if(!e)return null;let t="",o;if(e instanceof ArrayBuffer)o=new Uint8Array(e);else if(e instanceof Uint8Array)o=e;else if(Array.isArray(e))o=new Uint8Array(e);else return console.warn("Unknown binary data format:",typeof e),null;const r=8192;for(let n=0;n<o.length;n+=r){const s=o.subarray(n,Math.min(n+r,o.length));t+=String.fromCharCode.apply(null,s)}return"data:image/jpeg;base64,"+btoa(t)}catch(t){return console.error("Error converting binary to base64:",t),null}}function vt(){const e=document.querySelector(".nav-links a[href='#']");e&&e.addEventListener("click",c=>{c.preventDefault(),window.logout&&window.logout()});const t=document.getElementById("settings-form");t&&t.addEventListener("submit",yt);const o=document.getElementById("profile-image-input");o&&o.addEventListener("change",xt),["current-password","new-password","confirm-password"].forEach(c=>{const l=document.querySelector(`button[data-toggle="${c}"]`);l&&l.addEventListener("click",()=>bt(c))});const n=document.getElementById("back-button");n&&n.addEventListener("click",()=>{window.history.back()});const s=document.getElementById("delete-account-btn");s&&s.addEventListener("click",()=>{document.getElementById("delete-modal").classList.remove("hidden")});const i=document.getElementById("confirm-delete-btn");i&&i.addEventListener("click",kt);const d=document.getElementById("cancel-delete-btn");d&&d.addEventListener("click",be)}function xt(e){const t=e.target.files[0];if(!t)return;if(!t.type.startsWith("image/")){k("Please select an image file"),e.target.value="";return}if(t.size>5*1024*1024){k("Image size should be less than 5MB"),e.target.value="";return}const o=new FileReader;o.onload=r=>{const n=document.getElementById("profile-image-preview");n&&(n.src=r.target.result)},o.onerror=()=>{k("Error reading image file"),e.target.value=""},o.readAsDataURL(t)}function bt(e){const t=document.getElementById(e),o=document.querySelector(`button[data-toggle="${e}"] i`);t&&o&&(t.type==="password"?(t.type="text",o.classList.remove("fa-eye"),o.classList.add("fa-eye-slash")):(t.type="password",o.classList.remove("fa-eye-slash"),o.classList.add("fa-eye")))}function Et(){document.querySelectorAll('[id$="-error"]').forEach(t=>{t.classList.add("hidden"),t.textContent=""})}function C(e,t){const o=document.getElementById(`${e}-error`);o&&(o.textContent=t,o.classList.remove("hidden"))}function k(e){const t=document.getElementById("alert-modal"),o=document.getElementById("alert-icon"),r=document.getElementById("alert-title"),n=document.getElementById("alert-message"),s=document.getElementById("alert-close-btn");t&&o&&r&&n&&s&&(o.innerHTML='<i class="fas fa-exclamation-circle text-red-500 text-2xl"></i>',r.textContent="Error",n.textContent=e,t.classList.remove("hidden"),s.onclick=()=>{t.classList.add("hidden")})}function z(e="Profile updated successfully"){const t=document.getElementById("alert-modal"),o=document.getElementById("alert-icon"),r=document.getElementById("alert-title"),n=document.getElementById("alert-message"),s=document.getElementById("alert-close-btn");t&&o&&r&&n&&s&&(o.innerHTML='<i class="fas fa-check-circle text-green-500 text-2xl"></i>',r.textContent="Success",n.textContent=e,t.classList.remove("hidden"),s.onclick=()=>{t.classList.add("hidden")})}function ve(){const e=document.getElementById("loading-spinner");e&&e.classList.remove("hidden");const t=document.querySelector('#settings-form button[type="submit"]');t&&(t.disabled=!0,t.textContent="Updating...")}function xe(){const e=document.getElementById("loading-spinner");e&&e.classList.add("hidden");const t=document.querySelector('#settings-form button[type="submit"]');t&&(t.disabled=!1,t.textContent="Save Changes")}function be(){document.getElementById("delete-modal").classList.add("hidden")}async function kt(){ve();try{const e=await x("/api/profile",{method:"DELETE"});if(!e||!e.message)throw new Error("Invalid response from server");console.log("Account deleted successfully:",e.message),sessionStorage.removeItem("isLoggedIn"),sessionStorage.removeItem("user"),sessionStorage.removeItem("token"),z("Account deleted successfully"),setTimeout(()=>{window.loadView("login")},2e3)}catch(e){let t="Failed to delete account. Please try again or contact support at support@himo.com.";if(e.message.includes("HTTP 500")&&e.message.includes("details"))try{t=JSON.parse(e.message.split("HTTP 500 - ")[1]).details||t}catch(o){console.warn("Failed to parse error details:",o)}console.error("Error deleting account:",{message:e.message,stack:e.stack,response:e.message.includes("HTTP 500")?e.message:null}),k(t)}finally{be(),xe()}}window.openInNewTab=function(e){const t=window.open(window.location.origin+window.location.pathname+"#"+e,"_blank");t&&t.focus()};function Lt(e,t){var r;const o="https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_960_720.png";try{if(!t){e.src=o;return}if(typeof t=="string"){if(t.startsWith("http")||t.startsWith("data:image/")){e.src=t;return}if(t.startsWith("\\x"))try{const s=((r=t.substring(2).match(/.{2}/g))==null?void 0:r.map(i=>String.fromCharCode(parseInt(i,16))).join(""))||"";if(s.startsWith("http")){e.src=s;return}}catch(n){console.error("Error decoding hex string:",n)}}if(t&&typeof t=="object"&&t.data){const n=It(t.data);if(n){e.src=n;return}}e.src=o,e.onerror=()=>{e.src=o,e.onerror=null}}catch(n){console.error("Error displaying profile image:",n),e.src=o}}function It(e){try{if(!e)return null;let t="",o;if(e instanceof ArrayBuffer)o=new Uint8Array(e);else if(e instanceof Uint8Array)o=e;else if(Array.isArray(e))o=new Uint8Array(e);else return console.warn("Unknown binary data format:",typeof e),null;const r=8192;for(let n=0;n<o.length;n+=r){const s=o.subarray(n,Math.min(n+r,o.length));t+=String.fromCharCode.apply(null,s)}return"data:image/jpeg;base64,"+btoa(t)}catch(t){return console.error("Error converting binary to base64:",t),null}}window.updateNavbar=async function(){const e=document.getElementById("navbar-container");if(!e){console.error("Navbar container not found");return}const t=window.isUserLoggedIn(),o=t?"views/navbarLogin.html":"views/navbarNotLogin.html";try{const r=await fetch(o);if(!r.ok)throw new Error(`Failed to load navbar: ${o}`);const n=await r.text();e.innerHTML=n;const s=document.getElementById("menu-toggle"),i=document.getElementById("navbar-menu");if(s&&i&&(s.removeEventListener("click",window.toggleMobileMenu),window.toggleMobileMenu=()=>{i.classList.toggle("hidden")},s.addEventListener("click",window.toggleMobileMenu)),t){const d=window.getCurrentUser();d&&D(d),Bt().catch(console.error)}}catch(r){console.error("Error updating navbar:",r)}};function D(e){if(!e){console.warn("No user data provided to updateNavbarUI");return}const t=document.getElementById("profile-image"),o=document.getElementById("dropdown-username"),r=document.getElementById("dropdown-email");t&&Lt(t,e.img),o&&(o.textContent=e.name||"User"),r&&(r.textContent=e.email||"")}async function Bt(){const e=sessionStorage.getItem("token");if(e)try{const t=await fetch(`${API_BASE_URL}/profile`,{headers:{Authorization:`Bearer ${e}`}});if(t.ok){const o=await t.json();sessionStorage.setItem("user",JSON.stringify(o.user)),D(o.user)}}catch(t){console.error("Error fetching user profile:",t)}}window.loadView=function(e){e||(e=window.location.hash.substring(1)||(sessionStorage.getItem("isLoggedIn")==="true"?"curhat":"home")),e!=="home"?window.location.hash=e:window.location.hash="";const t=sessionStorage.getItem("isLoggedIn")==="true";console.log(`Attempting to load view: ${e}`),console.log(`isLoggedIn: ${t}`),e==="signup"||e==="login"||e==="forgetpassword"||e==="terms"||e==="privacy"?document.body.classList.add("no-navbar"):document.body.classList.remove("no-navbar"),e==="signup"||e==="login"||e==="dashboard"||e==="account"||e==="history"||e==="curhat"||e==="feedback"||e==="articles"||e==="forgetpassword"||e==="terms"||e==="privacy"?document.body.classList.add("contact"):document.body.classList.remove("contact");let o;switch(e){case"home":o=T;break;case"login":o=I;break;case"signup":o=Ce;break;case"articles":o=ot;break;case"curhat":o=t?G:I;break;case"feedback":o=t?K:I;break;case"dashboard":o=t?O:I;break;case"history":o=t?he:I;break;case"account":o=ft;break;case"forgetpassword":o=Ge;break;case"terms":o=renderTerms;break;case"privacy":o=renderPrivacy;break;default:o=T}if(o)try{o()}catch(r){console.error(`Error rendering view ${e}:`,r),I()}else console.error(`No render function found for view ${e}`),T();window.updateNavbar().then(()=>{if(t){const r=window.getCurrentUser();r&&D(r)}}).catch(r=>{console.error("Error updating navbar:",r)})};window.login=async function(e,t){sessionStorage.setItem("isLoggedIn","true"),e&&sessionStorage.setItem("user",JSON.stringify(e)),t&&sessionStorage.setItem("token",t),console.log("User logged in, isLoggedIn set to true"),console.log("User data:",e),D(e),await window.updateNavbar(),loadView("curhat")};window.logout=function(){sessionStorage.removeItem("isLoggedIn"),sessionStorage.removeItem("user"),sessionStorage.removeItem("token"),console.log("User logged out"),window.updateNavbar(),loadView("home")};window.getCurrentUser=function(){const e=sessionStorage.getItem("user");return e?JSON.parse(e):null};window.getAuthToken=function(){return sessionStorage.getItem("token")};window.isUserLoggedIn=function(){return sessionStorage.getItem("isLoggedIn")==="true"};window.addEventListener("DOMContentLoaded",()=>{const e=sessionStorage.getItem("isLoggedIn")==="true";console.log(`DOMContentLoaded: isLoggedIn = ${e}`),loadView(e?"curhat":"home")});
